<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الذهب المتكامل - النسخة النهائية</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #d4af37;
            --primary-dark: #b8942b;
            --secondary-color: #8b7355;
            --success-color: #28a745;
            --success-dark: #218838;
            --danger-color: #dc3545;
            --danger-dark: #c82333;
            --warning-color: #ffc107;
            --warning-dark: #e0a800;
            --info-color: #17a2b8;
            --info-dark: #138496;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --developer-color: #6f42c1;
            --cash-color: #28a745;
            --expense-color: #dc3545;
            --employee-color: #17a2b8;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1600px;
            margin: 0 auto;
        }

        /* مؤشر الحفظ التلقائي */
        .autosave-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 15px 25px;
            border-radius: 50px;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideIn 0.3s ease;
            font-weight: 500;
        }

        .autosave-indicator.show {
            display: flex;
        }

        /* حالة الشبكة */
        .network-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 10px 20px;
            border-radius: 50px;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 9999;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            font-weight: 500;
        }

        .network-status.online {
            background: var(--success-color);
        }

        .network-status.offline {
            background: var(--danger-color);
        }

        /* توقيع المطور */
        .developer-signature {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--developer-color);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 9999;
            box-shadow: 0 4px 20px rgba(0,0,0,0.3);
            animation: slideInLeft 0.3s ease;
            direction: ltr;
            font-weight: 500;
        }

        .developer-signature a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.2);
            padding: 5px 12px;
            border-radius: 50px;
            transition: all 0.3s;
        }

        .developer-signature a:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        /* الشريط العلوي الرئيسي */
        .main-header {
            background: white;
            padding: 25px 35px;
            border-radius: 20px 20px 0 0;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 20px;
        }

        .main-header h1 {
            color: var(--primary-color);
            font-size: 32px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .global-stats {
            display: flex;
            gap: 20px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: var(--light-color);
            padding: 12px 25px;
            border-radius: 50px;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .stat-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .stat-item span:first-child {
            color: var(--secondary-color);
            margin-left: 10px;
        }

        .stat-item span:last-child {
            color: var(--primary-color);
            font-weight: 700;
        }

        /* بطاقات الخزنة */
        .cash-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .cash-card {
            background: linear-gradient(135deg, var(--cash-color), #34ce57);
            color: white;
            padding: 25px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 20px rgba(0,0,0,0.15);
            transition: all 0.3s;
            cursor: pointer;
        }

        .cash-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.2);
        }

        .cash-card.expense-card {
            background: linear-gradient(135deg, var(--expense-color), #e35d6a);
        }

        .cash-card.employee-card {
            background: linear-gradient(135deg, var(--employee-color), #1c7cd6);
        }

        .cash-card h3 {
            font-size: 18px;
            margin-bottom: 15px;
            opacity: 0.9;
        }

        .cash-card .amount {
            font-size: 36px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .cash-card .small {
            font-size: 14px;
            opacity: 0.8;
        }

        /* التاب العلوي */
        .main-tabs {
            background: white;
            padding: 15px 25px 0 25px;
            display: flex;
            gap: 5px;
            border-bottom: 3px solid var(--primary-color);
            flex-wrap: wrap;
            overflow-x: auto;
            scrollbar-width: thin;
        }

        .main-tabs::-webkit-scrollbar {
            height: 5px;
        }

        .main-tabs::-webkit-scrollbar-thumb {
            background: var(--primary-color);
            border-radius: 10px;
        }

        .main-tab {
            padding: 15px 25px;
            background: #f5f5f5;
            border: none;
            border-radius: 10px 10px 0 0;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-family: 'Tajawal', sans-serif;
            white-space: nowrap;
        }

        .main-tab i {
            font-size: 18px;
        }

        .main-tab:hover {
            background: #e0e0e0;
            transform: translateY(-2px);
        }

        .main-tab.active {
            background: var(--primary-color);
            color: white;
            box-shadow: 0 -2px 10px rgba(212, 175, 55, 0.3);
        }

        /* محتوى التاب */
        .main-content {
            background: white;
            padding: 30px;
            border-radius: 0 0 20px 20px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tab-pane {
            display: none;
            animation: fadeIn 0.3s ease;
        }

        .tab-pane.active {
            display: block;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* أقسام البحث */
        .search-section {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            transition: all 0.3s;
        }

        .search-section:hover {
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
            margin-bottom: 15px;
        }

        .search-result {
            margin-top: 20px;
            padding: 20px;
            background: white;
            border-radius: 10px;
            border-right: 4px solid var(--primary-color);
            max-height: 400px;
            overflow-y: auto;
        }

        /* أقسام الإدارة الداخلية */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h2 {
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 24px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(450px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-card {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            transition: all 0.3s;
        }

        .form-card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .form-card h3 {
            color: var(--secondary-color);
            margin-bottom: 25px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            font-size: 20px;
        }

        .list-card {
            background: #f8f9fa;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 2px 15px rgba(0,0,0,0.05);
            max-height: 600px;
            overflow-y: auto;
            transition: all 0.3s;
        }

        .list-card:hover {
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
        }

        .list-card h3 {
            color: var(--secondary-color);
            margin-bottom: 25px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
            font-size: 20px;
            position: sticky;
            top: 0;
            background: #f8f9fa;
            z-index: 10;
        }

        /* النماذج */
        .form-group {
            margin-bottom: 20px;
        }

        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 12px 15px;
            border: 2px solid #e0e0e0;
            border-radius: 10px;
            font-size: 16px;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s;
        }

        .form-group input:hover,
        .form-group select:hover,
        .form-group textarea:hover {
            border-color: var(--primary-color);
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.1);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* بطاقات العناصر */
        .items-list {
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .list-item {
            background: white;
            padding: 20px;
            border-radius: 12px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-right: 4px solid var(--primary-color);
            transition: all 0.3s;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }

        .list-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }

        .item-info h4 {
            color: var(--dark-color);
            margin-bottom: 5px;
            font-size: 18px;
        }

        .item-info p {
            color: #666;
            font-size: 14px;
            margin: 3px 0;
        }

        .item-info small {
            color: #999;
        }

        .item-actions {
            display: flex;
            gap: 8px;
        }

        .item-actions button {
            padding: 8px 15px;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            color: white;
            font-size: 13px;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            gap: 5px;
        }

        .item-actions button:hover {
            transform: scale(1.1);
        }

        .btn-edit {
            background: var(--warning-color);
        }
        .btn-edit:hover { background: var(--warning-dark); }

        .btn-delete {
            background: var(--danger-color);
        }
        .btn-delete:hover { background: var(--danger-dark); }

        .btn-view {
            background: var(--info-color);
        }
        .btn-view:hover { background: var(--info-dark); }

        .btn-print {
            background: var(--primary-color);
        }
        .btn-print:hover { background: var(--primary-dark); }

        /* قسم المبيعات */
        .sell-section {
            background: linear-gradient(135deg, #e8f5e9, #c8e6c9);
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            transition: all 0.3s;
        }

        .sell-section:hover {
            box-shadow: 0 5px 20px rgba(40, 167, 69, 0.2);
        }

        .sell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 25px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .sell-header h3 {
            color: var(--success-color);
            font-size: 22px;
        }

        .invoice-number {
            background: var(--primary-color);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            font-weight: 700;
            font-size: 18px;
            box-shadow: 0 2px 10px rgba(212, 175, 55, 0.3);
        }

        .sell-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(220px, 1fr));
            gap: 20px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-control input {
            width: 80px;
            text-align: center;
            font-size: 18px;
            font-weight: 700;
        }

        .quantity-control button {
            width: 40px;
            height: 40px;
            border: none;
            border-radius: 10px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 18px;
            font-weight: 700;
            transition: all 0.3s;
        }

        .quantity-control button:hover {
            background: var(--primary-dark);
            transform: scale(1.1);
        }

        .stock-info {
            background: white;
            padding: 15px;
            border-radius: 10px;
            color: var(--info-color);
            font-weight: 500;
            margin-top: 10px;
            border-right: 4px solid var(--info-color);
        }

        /* قسم المرتجعات */
        .return-section {
            background: #fff3cd;
            padding: 25px;
            border-radius: 15px;
            margin-bottom: 25px;
            transition: all 0.3s;
        }

        .return-section:hover {
            box-shadow: 0 5px 20px rgba(255, 193, 7, 0.2);
        }

        .return-header {
            color: #856404;
            margin-bottom: 20px;
        }

        .return-header h3 {
            font-size: 22px;
        }

        /* الجداول */
        .table-responsive {
            overflow-x: auto;
            border-radius: 10px;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
            font-size: 14px;
        }

        th {
            background: var(--primary-color);
            color: white;
            padding: 15px;
            font-weight: 500;
            text-align: center;
            position: sticky;
            top: 0;
            z-index: 10;
        }

        td {
            padding: 12px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .badge {
            padding: 5px 12px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 500;
            display: inline-block;
        }

        .badge-success {
            background: var(--success-color);
            color: white;
        }

        .badge-warning {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        .badge-danger {
            background: var(--danger-color);
            color: white;
        }

        .badge-info {
            background: var(--info-color);
            color: white;
        }

        /* الأزرار */
        .btn {
            padding: 12px 25px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0,0,0,0.2);
        }

        .btn:active {
            transform: translateY(0);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }
        .btn-primary:hover { background: var(--primary-dark); }

        .btn-success {
            background: var(--success-color);
            color: white;
        }
        .btn-success:hover { background: var(--success-dark); }

        .btn-info {
            background: var(--info-color);
            color: white;
        }
        .btn-info:hover { background: var(--info-dark); }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }
        .btn-danger:hover { background: var(--danger-dark); }

        .btn-warning {
            background: var(--warning-color);
            color: var(--dark-color);
        }
        .btn-warning:hover { background: var(--warning-dark); }

        .btn-excel {
            background: #1d6f42;
            color: white;
        }
        .btn-excel:hover { background: #155d36; }

        .btn-pdf {
            background: #dc3545;
            color: white;
        }
        .btn-pdf:hover { background: #bd2130; }

        .btn-print {
            background: #6f42c1;
            color: white;
        }
        .btn-print:hover { background: #5e3aa8; }

        .btn-backup {
            background: #fd7e14;
            color: white;
        }
        .btn-backup:hover { background: #e56b08; }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        .export-buttons {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
            justify-content: center;
        }

        /* نافذة الطباعة */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background: white;
                padding: 0;
            }
            .invoice-container {
                padding: 20px;
                max-width: 100%;
            }
        }

        .invoice-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .invoice-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 20px;
        }

        .invoice-header h1 {
            color: var(--primary-color);
            font-size: 32px;
            margin-bottom: 10px;
        }

        .invoice-header h2 {
            color: var(--secondary-color);
            font-size: 24px;
        }

        .invoice-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }

        .info-item {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 10px;
            border-right: 3px solid var(--primary-color);
        }

        .info-item strong {
            color: var(--secondary-color);
            display: block;
            margin-bottom: 5px;
        }

        /* رسائل التنبيه */
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 50px;
            color: white;
            font-weight: 500;
            z-index: 10000;
            animation: slideDown 0.3s ease;
            box-shadow: 0 4px 20px rgba(0,0,0,0.2);
        }

        .alert-success {
            background: var(--success-color);
        }

        .alert-error {
            background: var(--danger-color);
        }

        .alert-warning {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        .alert-info {
            background: var(--info-color);
        }

        @keyframes slideDown {
            from {
                top: -100px;
                opacity: 0;
            }
            to {
                top: 20px;
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                right: -100px;
                opacity: 0;
            }
            to {
                right: 20px;
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                left: -100px;
                opacity: 0;
            }
            to {
                left: 20px;
                opacity: 1;
            }
        }

        /* مؤشر التحميل */
        .loading {
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 3px solid rgba(255,255,255,.3);
            border-radius: 50%;
            border-top-color: white;
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* التجاوب مع الشاشات */
        @media (max-width: 768px) {
            body { padding: 10px; }
            
            .main-header {
                flex-direction: column;
                text-align: center;
                padding: 20px;
            }
            
            .main-header h1 { font-size: 24px; }
            
            .global-stats {
                width: 100%;
                justify-content: center;
            }
            
            .stat-item {
                width: 100%;
                text-align: center;
            }
            
            .main-tabs {
                justify-content: flex-start;
                padding: 10px 15px 0;
            }
            
            .main-tab {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .section-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .developer-signature {
                bottom: 10px;
                left: 10px;
                font-size: 12px;
                padding: 8px 15px;
                flex-wrap: wrap;
            }

            .cash-summary {
                grid-template-columns: 1fr;
            }

            .sell-form {
                grid-template-columns: 1fr;
            }

            .export-buttons {
                flex-direction: column;
            }

            .export-buttons .btn {
                width: 100%;
                justify-content: center;
            }
        }
    </style>
</head>
<body>
    <!-- مؤشر حالة الشبكة -->
    <div id="networkStatus" class="network-status online">
        <i class="fas fa-wifi"></i>
        <span>متصل بالإنترنت</span>
    </div>

    <!-- مؤشر الحفظ التلقائي -->
    <div id="autosaveIndicator" class="autosave-indicator">
        <i class="fas fa-check-circle"></i>
        <span>تم الحفظ تلقائياً</span>
    </div>

    <!-- توقيع المطور -->
    <div class="developer-signature">
        <i class="fas fa-code"></i>
        <span>تطوير: محمد أحمد فؤاد</span>
        <a href="https://wa.me/201010421571" target="_blank">
            <i class="fab fa-whatsapp"></i>
            +201010421571
        </a>
    </div>

    <div class="container">
        <!-- الشريط العلوي -->
        <header class="main-header">
            <h1><i class="fas fa-gem"></i> نظام إدارة الذهب المتكامل</h1>
            <div class="global-stats">
                <div class="stat-item">
                    <span><i class="fas fa-users"></i> العملاء:</span>
                    <span id="totalCustomers">0</span>
                </div>
                <div class="stat-item">
                    <span><i class="fas fa-boxes"></i> القطع:</span>
                    <span id="totalItems">0</span>
                </div>
                <div class="stat-item">
                    <span><i class="fas fa-user-tie"></i> الموظفين:</span>
                    <span id="totalEmployees">0</span>
                </div>
                <div class="stat-item">
                    <span><i class="fas fa-coins"></i> الخزنة:</span>
                    <span id="cashBalance">0</span>
                </div>
            </div>
        </header>

        <!-- بطاقات الخزنة -->
        <div class="cash-summary">
            <div class="cash-card" onclick="inventory.addToCash()">
                <h3><i class="fas fa-plus-circle"></i> رصيد الخزنة الحالي</h3>
                <div class="amount" id="currentCash">0</div>
                <div class="small">اضغط للإيداع - آخر تحديث: <span id="lastCashUpdate"></span></div>
            </div>
            <div class="cash-card expense-card" onclick="inventory.addExpense()">
                <h3><i class="fas fa-minus-circle"></i> إجمالي المصروفات</h3>
                <div class="amount" id="totalExpenses">0</div>
                <div class="small">اضغط لإضافة مصروف - هذا الشهر</div>
            </div>
            <div class="cash-card employee-card" onclick="inventory.switchMainTab('employees')">
                <h3><i class="fas fa-user-tie"></i> إجمالي الرواتب</h3>
                <div class="amount" id="totalSalaries">0</div>
                <div class="small">اضغط لإدارة الموظفين - هذا الشهر</div>
            </div>
        </div>

        <!-- التاب العلوي -->
        <div class="main-tabs">
            <button class="main-tab" data-tab="search" onclick="inventory.switchMainTab('search')">
                <i class="fas fa-search"></i>
                بحث
            </button>
            <button class="main-tab active" data-tab="inventory" onclick="inventory.switchMainTab('inventory')">
                <i class="fas fa-boxes"></i>
                المخزون
            </button>
            <button class="main-tab" data-tab="customers" onclick="inventory.switchMainTab('customers')">
                <i class="fas fa-users"></i>
                العملاء
            </button>
            <button class="main-tab" data-tab="employees" onclick="inventory.switchMainTab('employees')">
                <i class="fas fa-user-tie"></i>
                الموظفين
            </button>
            <button class="main-tab" data-tab="sales" onclick="inventory.switchMainTab('sales')">
                <i class="fas fa-chart-line"></i>
                المبيعات
            </button>
            <button class="main-tab" data-tab="cash" onclick="inventory.switchMainTab('cash')">
                <i class="fas fa-coins"></i>
                الخزنة
            </button>
            <button class="main-tab" data-tab="expenses" onclick="inventory.switchMainTab('expenses')">
                <i class="fas fa-file-invoice"></i>
                المصروفات
            </button>
            <button class="main-tab" data-tab="companies" onclick="inventory.switchMainTab('companies')">
                <i class="fas fa-building"></i>
                الشركات
            </button>
            <button class="main-tab" data-tab="categories" onclick="inventory.switchMainTab('categories')">
                <i class="fas fa-tags"></i>
                الأصناف
            </button>
        </div>

        <!-- محتوى التاب - بحث -->
        <div id="search-tab" class="main-content tab-pane">
            <div class="section-header">
                <h2><i class="fas fa-search"></i> بحث متقدم</h2>
            </div>

            <div class="search-section">
                <h3><i class="fas fa-gem"></i> بحث عن منتج</h3>
                <div class="search-grid">
                    <div class="form-group">
                        <label>البحث بالباركود</label>
                        <input type="text" id="searchProductBarcode" placeholder="أدخل الباركود">
                    </div>
                    <div class="form-group">
                        <label>البحث بالاسم</label>
                        <input type="text" id="searchProductName" placeholder="أدخل اسم المنتج">
                    </div>
                    <div class="form-group">
                        <label>البحث بالشركة</label>
                        <select id="searchProductCompany">
                            <option value="all">جميع الشركات</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>البحث بالصنف</label>
                        <select id="searchProductCategory">
                            <option value="all">جميع الأصناف</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="inventory.searchProducts()">
                    <i class="fas fa-search"></i> بحث
                </button>
                <div id="productSearchResult" class="search-result"></div>
            </div>

            <div class="search-section">
                <h3><i class="fas fa-file-invoice"></i> بحث عن فاتورة</h3>
                <div class="search-grid">
                    <div class="form-group">
                        <label>رقم الفاتورة</label>
                        <input type="text" id="searchInvoiceNumber" placeholder="أدخل رقم الفاتورة">
                    </div>
                    <div class="form-group">
                        <label>تاريخ الفاتورة</label>
                        <input type="date" id="searchInvoiceDate">
                    </div>
                    <div class="form-group">
                        <label>اسم العميل</label>
                        <input type="text" id="searchInvoiceCustomer" placeholder="أدخل اسم العميل">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="inventory.searchInvoices()">
                    <i class="fas fa-search"></i> بحث
                </button>
                <div id="invoiceSearchResult" class="search-result"></div>
            </div>

            <div class="search-section">
                <h3><i class="fas fa-coins"></i> بحث في الخزنة</h3>
                <div class="search-grid">
                    <div class="form-group">
                        <label>من تاريخ</label>
                        <input type="date" id="searchCashFrom">
                    </div>
                    <div class="form-group">
                        <label>إلى تاريخ</label>
                        <input type="date" id="searchCashTo">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="inventory.searchCash()">
                    <i class="fas fa-search"></i> بحث
                </button>
                <div id="cashSearchResult" class="search-result"></div>
            </div>
        </div>

        <!-- محتوى التاب - المخزون -->
        <div id="inventory-tab" class="main-content tab-pane active">
            <!-- قسم السعر الرئيسي -->
            <div class="price-section" style="margin-bottom: 20px;">
                <h2><i class="fas fa-chart-line"></i> تحديد سعر الذهب عيار 21</h2>
                <div class="price-input">
                    <label for="mainGoldPrice">سعر جرام الذهب عيار 21:</label>
                    <input type="number" id="mainGoldPrice" step="0.01" min="0" value="0" placeholder="أدخل السعر">
                    <button id="applyPriceBtn" class="btn btn-success" onclick="inventory.setMainGoldPrice()">
                        <i class="fas fa-check"></i> تطبيق السعر
                    </button>
                </div>
                <div class="price-note">
                    <i class="fas fa-info-circle"></i> طريقة حساب العيارات:
                    <span>عيار 24 = سعر 21 × (24/21)</span> |
                    <span>عيار 18 = سعر 21 × (18/21)</span>
                </div>
            </div>

            <!-- الماسح الضوئي للباركود -->
            <div class="scanner-section" style="margin-bottom: 20px;">
                <div class="scanner-header">
                    <h2><i class="fas fa-camera"></i> ماسح الباركود</h2>
                    <button id="startScanner" class="btn btn-primary" onclick="inventory.toggleScanner()">
                        <i class="fas fa-play"></i> تشغيل الماسح
                    </button>
                </div>
                <div id="scanner-container" class="scanner-container" style="display: none;">
                    <video id="scanner-video"></video>
                    <div class="scanner-overlay">
                        <div class="scanner-line"></div>
                    </div>
                </div>
                <div class="manual-input">
                    <input type="text" id="barcodeInput" placeholder="أدخل الباركود يدوياً">
                    <button id="addBarcodeBtn" class="btn btn-success" onclick="inventory.addManualBarcode()">
                        <i class="fas fa-plus"></i> إضافة
                    </button>
                </div>
                <div class="barcode-auto-generate">
                    <i class="fas fa-info-circle"></i>
                    <span>إذا لم تقم بإدخال باركود، سيتم إنشاء باركود تلقائي عند الحفظ</span>
                </div>
                <div id="barcodeDuplicateWarning" class="barcode-duplicate-warning">
                    <i class="fas fa-exclamation-triangle"></i>
                    <span>هذا الباركود موجود مسبقاً! سيتم تحديث البيانات بدلاً من إضافة قطعة جديدة.</span>
                </div>
            </div>

            <!-- نموذج إضافة قطعة جديدة -->
            <div class="add-item-section" style="margin-bottom: 20px;">
                <h2><i class="fas fa-plus-circle"></i> إضافة قطعة جديدة</h2>
                <form id="itemForm" class="item-form">
                    <div class="form-grid">
                        <div class="form-group">
                            <label for="barcode">الباركود</label>
                            <input type="text" id="barcode" placeholder="سيتم إنشاؤه تلقائياً">
                        </div>
                        <div class="form-group">
                            <label for="itemName">اسم القطعة</label>
                            <input type="text" id="itemName" required placeholder="أدخل اسم القطعة">
                        </div>
                        <div class="form-group">
                            <label for="company">الشركة</label>
                            <select id="company" required>
                                <option value="">اختر الشركة</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="category">الصنف</label>
                            <select id="category" required>
                                <option value="">اختر الصنف</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="quantity">الكمية</label>
                            <input type="number" id="quantity" min="1" value="1" placeholder="الكمية">
                        </div>
                        <div class="form-group">
                            <label for="weight">الوزن (جرام)</label>
                            <input type="number" id="weight" step="0.01" min="0" required placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="goldType">نوع العيار</label>
                            <select id="goldType" required>
                                <option value="24">عيار 24</option>
                                <option value="21" selected>عيار 21</option>
                                <option value="18">عيار 18</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="manufacturingPrice">سعر المصنعية</label>
                            <input type="number" id="manufacturingPrice" step="0.01" min="0" value="0" placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="goldPrice">سعر الذهب (للجرام)</label>
                            <input type="number" id="goldPrice" step="0.01" readonly placeholder="يتم الحساب تلقائياً">
                        </div>
                        <div class="form-group">
                            <label for="totalSellingPrice">سعر البيع للقطعة</label>
                            <input type="number" id="totalSellingPrice" step="0.01" readonly placeholder="0.00">
                        </div>
                        <div class="form-group">
                            <label for="notes">ملاحظات</label>
                            <textarea id="notes" placeholder="ملاحظات إضافية"></textarea>
                        </div>
                    </div>
                    
                    <div class="checkbox-group">
                        <div class="checkbox-item">
                            <input type="checkbox" id="includeManufacturing" checked>
                            <label for="includeManufacturing">شامل المصنعية</label>
                        </div>
                        <div class="checkbox-item">
                            <input type="checkbox" id="wholesalePrice">
                            <label for="wholesalePrice">سعر الجملة (خصم 5%)</label>
                        </div>
                    </div>

                    <div class="form-buttons">
                        <button type="submit" class="btn btn-success" onclick="inventory.addItem(event)">
                            <i class="fas fa-save"></i> حفظ القطعة
                        </button>
                        <button type="button" class="btn btn-info" id="calculatePrice" onclick="inventory.calculateTotalPrice()">
                            <i class="fas fa-calculator"></i> حساب السعر
                        </button>
                    </div>
                </form>
            </div>

            <!-- الفلاتر والجداول -->
            <div class="inventory-sections">
                <div class="filters">
                    <div class="filter-group">
                        <label>تصفية حسب الشركة</label>
                        <select id="filterCompany" onchange="inventory.applyFilters()">
                            <option value="all">جميع الشركات</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>تصفية حسب الصنف</label>
                        <select id="filterCategory" onchange="inventory.applyFilters()">
                            <option value="all">جميع الأصناف</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>تصفية حسب العيار</label>
                        <select id="filterGoldType" onchange="inventory.applyFilters()">
                            <option value="all">جميع العيارات</option>
                            <option value="24">عيار 24</option>
                            <option value="21">عيار 21</option>
                            <option value="18">عيار 18</option>
                        </select>
                    </div>
                    <div class="filter-group">
                        <label>تصفية حسب النوع</label>
                        <select id="filterPriceType" onchange="inventory.applyFilters()">
                            <option value="all">الكل</option>
                            <option value="retail">قطاعي</option>
                            <option value="wholesale">جملة</option>
                        </select>
                    </div>
                    <button class="btn btn-secondary" onclick="inventory.clearFilters()">
                        <i class="fas fa-times"></i> مسح الفلاتر
                    </button>
                </div>

                <div class="section-tabs">
                    <button class="tab-btn active" onclick="inventory.switchInventoryTab('all')">كل القطع</button>
                    <button class="tab-btn" onclick="inventory.switchInventoryTab('manufacturing')">المصنعية فقط</button>
                    <button class="tab-btn" onclick="inventory.switchInventoryTab('gold')">الذهب فقط</button>
                </div>

                <!-- جدول جميع القطع -->
                <div id="all-items" class="tab-content active">
                    <div class="table-header">
                        <h3><i class="fas fa-list"></i> جميع القطع</h3>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchAll" placeholder="بحث..." onkeyup="inventory.searchItems(this.value, 'all')">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="allItemsTable">
                            <thead>
                                <tr>
                                    <th>الباركود</th>
                                    <th>القطعة</th>
                                    <th>الشركة</th>
                                    <th>الصنف</th>
                                    <th>الكمية</th>
                                    <th>الوزن</th>
                                    <th>العيار</th>
                                    <th>المصنعية</th>
                                    <th>سعر الذهب</th>
                                    <th>النوع</th>
                                    <th>الإجمالي</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="allItemsBody"></tbody>
                            <tfoot id="allItemsFooter"></tfoot>
                        </table>
                    </div>
                </div>

                <!-- جدول المصنعية فقط -->
                <div id="manufacturing-items" class="tab-content">
                    <div class="table-header">
                        <h3><i class="fas fa-cog"></i> المصنعية فقط</h3>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchManufacturing" placeholder="بحث..." onkeyup="inventory.searchItems(this.value, 'manufacturing')">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="manufacturingTable">
                            <thead>
                                <tr>
                                    <th>الباركود</th>
                                    <th>القطعة</th>
                                    <th>الشركة</th>
                                    <th>الصنف</th>
                                    <th>الكمية</th>
                                    <th>الوزن</th>
                                    <th>العيار</th>
                                    <th>المصنعية</th>
                                    <th>النوع</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="manufacturingBody"></tbody>
                            <tfoot id="manufacturingFooter"></tfoot>
                        </table>
                    </div>
                </div>

                <!-- جدول الذهب فقط -->
                <div id="gold-items" class="tab-content">
                    <div class="table-header">
                        <h3><i class="fas fa-coins"></i> الذهب فقط</h3>
                        <div class="search-box">
                            <i class="fas fa-search"></i>
                            <input type="text" id="searchGold" placeholder="بحث..." onkeyup="inventory.searchItems(this.value, 'gold')">
                        </div>
                    </div>
                    <div class="table-responsive">
                        <table id="goldTable">
                            <thead>
                                <tr>
                                    <th>الباركود</th>
                                    <th>القطعة</th>
                                    <th>الشركة</th>
                                    <th>الصنف</th>
                                    <th>الكمية</th>
                                    <th>الوزن</th>
                                    <th>العيار</th>
                                    <th>سعر الذهب</th>
                                    <th>النوع</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="goldBody"></tbody>
                            <tfoot id="goldFooter"></tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- محتوى التاب - العملاء -->
        <div id="customers-tab" class="main-content tab-pane">
            <div class="section-header">
                <h2><i class="fas fa-user-plus"></i> إدارة العملاء</h2>
            </div>
            
            <div class="section-grid">
                <!-- إضافة عميل جديد -->
                <div class="form-card">
                    <h3>إضافة عميل جديد</h3>
                    <form id="customerForm" onsubmit="inventory.addCustomer(event)">
                        <div class="form-group">
                            <label>اسم العميل</label>
                            <input type="text" id="customerName" required placeholder="أدخل اسم العميل">
                        </div>
                        <div class="form-group">
                            <label>رقم الهاتف</label>
                            <input type="text" id="customerPhone" placeholder="أدخل رقم الهاتف">
                        </div>
                        <div class="form-group">
                            <label>البريد الإلكتروني</label>
                            <input type="email" id="customerEmail" placeholder="أدخل البريد الإلكتروني">
                        </div>
                        <div class="form-group">
                            <label>العنوان</label>
                            <textarea id="customerAddress" placeholder="أدخل العنوان"></textarea>
                        </div>
                        <div class="form-group">
                            <label>ملاحظات</label>
                            <textarea id="customerNotes" placeholder="ملاحظات إضافية"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> حفظ العميل
                        </button>
                    </form>
                </div>

                <!-- قائمة العملاء -->
                <div class="list-card">
                    <h3>قائمة العملاء</h3>
                    <div id="customersList" class="items-list"></div>
                </div>
            </div>

            <!-- سجل مبيعات العملاء -->
            <div class="list-card" style="margin-top: 20px;">
                <h3>سجل مبيعات العملاء</h3>
                <div class="table-responsive">
                    <table id="customerSalesTable">
                        <thead>
                            <tr>
                                <th>العميل</th>
                                <th>عدد المشتريات</th>
                                <th>إجمالي المشتريات</th>
                                <th>آخر شراء</th>
                            </tr>
                        </thead>
                        <tbody id="customerSalesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- محتوى التاب - الموظفين -->
        <div id="employees-tab" class="main-content tab-pane">
            <div class="section-header">
                <h2><i class="fas fa-user-tie"></i> إدارة الموظفين</h2>
            </div>
            
            <div class="section-grid">
                <!-- إضافة موظف جديد -->
                <div class="form-card">
                    <h3>إضافة موظف جديد</h3>
                    <form id="employeeForm" onsubmit="inventory.addEmployee(event)">
                        <div class="form-group">
                            <label>اسم الموظف</label>
                            <input type="text" id="employeeName" required placeholder="أدخل اسم الموظف">
                        </div>
                        <div class="form-group">
                            <label>رقم الهاتف</label>
                            <input type="text" id="employeePhone" placeholder="أدخل رقم الهاتف">
                        </div>
                        <div class="form-group">
                            <label>الوظيفة</label>
                            <input type="text" id="employeePosition" placeholder="أدخل الوظيفة">
                        </div>
                        <div class="form-group">
                            <label>الراتب الشهري</label>
                            <input type="number" id="employeeSalary" step="0.01" min="0" value="0" placeholder="أدخل الراتب">
                        </div>
                        <div class="form-group">
                            <label>تاريخ التعيين</label>
                            <input type="date" id="employeeHireDate" value="">
                        </div>
                        <div class="form-group">
                            <label>ملاحظات</label>
                            <textarea id="employeeNotes" placeholder="ملاحظات إضافية"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> حفظ الموظف
                        </button>
                    </form>
                </div>

                <!-- قائمة الموظفين -->
                <div class="list-card">
                    <h3>قائمة الموظفين</h3>
                    <div id="employeesList" class="items-list"></div>
                </div>
            </div>

            <!-- سجل مبيعات الموظفين -->
            <div class="list-card" style="margin-top: 20px;">
                <h3>سجل مبيعات الموظفين</h3>
                <div class="table-responsive">
                    <table id="employeeSalesTable">
                        <thead>
                            <tr>
                                <th>الموظف</th>
                                <th>عدد المبيعات</th>
                                <th>إجمالي المبيعات</th>
                                <th>الراتب الشهري</th>
                            </tr>
                        </thead>
                        <tbody id="employeeSalesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- محتوى التاب - المبيعات -->
        <div id="sales-tab" class="main-content tab-pane">
            <div class="section-header">
                <h2><i class="fas fa-shopping-cart"></i> إدارة المبيعات</h2>
                <div class="header-actions">
                    <button class="btn btn-info" onclick="inventory.showTodaySales()">
                        <i class="fas fa-calendar-day"></i> مبيعات اليوم
                    </button>
                    <button class="btn btn-warning" onclick="inventory.showReturns()">
                        <i class="fas fa-undo"></i> عرض المرتجعات
                    </button>
                </div>
            </div>

            <!-- قسم البيع السريع -->
            <div class="sell-section">
                <div class="sell-header">
                    <h3>فاتورة بيع جديدة</h3>
                    <div class="invoice-number">
                        فاتورة رقم: <span id="invoiceNumber">000001</span>
                    </div>
                </div>
                <form id="sellForm" class="sell-form" onsubmit="inventory.processSale(event)">
                    <div class="form-group">
                        <label>الباركود</label>
                        <input type="text" id="sellBarcode" placeholder="أدخل الباركود" oninput="inventory.searchItemForSale(this.value)">
                    </div>
                    <div class="form-group">
                        <label>اختر العميل</label>
                        <select id="sellCustomer" required>
                            <option value="">اختر العميل</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>اختر الموظف</label>
                        <select id="sellEmployee" required>
                            <option value="">اختر الموظف</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>الكمية</label>
                        <div class="quantity-control">
                            <button type="button" onclick="inventory.adjustQuantity(-1)">-</button>
                            <input type="number" id="sellQuantity" min="1" value="1" oninput="inventory.updateSaleTotal()">
                            <button type="button" onclick="inventory.adjustQuantity(1)">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label>سعر البيع</label>
                        <input type="number" id="sellPrice" step="0.01" readonly>
                    </div>
                    <div class="form-group">
                        <label>الإجمالي</label>
                        <input type="number" id="sellTotal" step="0.01" readonly>
                    </div>
                    <div class="form-group">
                        <label>طريقة الدفع</label>
                        <select id="sellPayment">
                            <option value="cash">نقدي</option>
                            <option value="card">بطاقة</option>
                            <option value="transfer">تحويل بنكي</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>ملاحظات</label>
                        <textarea id="sellNotes" placeholder="ملاحظات"></textarea>
                    </div>
                    <div class="stock-info" id="stockInfo"></div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> تأكيد البيع
                    </button>
                    <button type="button" class="btn btn-primary" onclick="inventory.printInvoice()">
                        <i class="fas fa-print"></i> طباعة الفاتورة
                    </button>
                </form>
            </div>

            <!-- قسم المرتجعات -->
            <div class="return-section" id="returnSection" style="display: none;">
                <div class="return-header">
                    <h3><i class="fas fa-undo"></i> مرتجع فاتورة</h3>
                </div>
                <form id="returnForm" class="sell-form" onsubmit="inventory.processReturn(event)">
                    <div class="form-group">
                        <label>رقم الفاتورة</label>
                        <input type="text" id="returnInvoice" placeholder="أدخل رقم الفاتورة" required>
                    </div>
                    <div class="form-group">
                        <label>سبب المرتجع</label>
                        <select id="returnReason" required>
                            <option value="defect">عيب في المنتج</option>
                            <option value="customer">رغبة العميل</option>
                            <option value="wrong">خطأ في الفاتورة</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>الكمية المرتجعة</label>
                        <input type="number" id="returnQuantity" min="1" value="1" required>
                    </div>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-undo"></i> تأكيد المرتجع
                    </button>
                    <button type="button" class="btn btn-secondary" onclick="document.getElementById('returnSection').style.display='none'">
                        <i class="fas fa-times"></i> إلغاء
                    </button>
                </form>
            </div>

            <!-- سجل المبيعات -->
            <div class="list-card">
                <h3>سجل المبيعات</h3>
                <div class="table-responsive">
                    <table id="salesTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>الباركود</th>
                                <th>القطعة</th>
                                <th>العميل</th>
                                <th>الموظف</th>
                                <th>الكمية</th>
                                <th>سعر الوحدة</th>
                                <th>الإجمالي</th>
                                <th>طريقة الدفع</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="salesBody"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="8" class="text-left"><strong>إجمالي المبيعات:</strong></td>
                                <td id="totalSales" colspan="4"><strong>0</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- محتوى التاب - الخزنة -->
        <div id="cash-tab" class="main-content tab-pane">
            <div class="section-header">
                <h2><i class="fas fa-coins"></i> إدارة الخزنة</h2>
                <div class="header-actions">
                    <button class="btn btn-success" onclick="inventory.addToCash()">
                        <i class="fas fa-plus"></i> إيداع
                    </button>
                    <button class="btn btn-danger" onclick="inventory.withdrawFromCash()">
                        <i class="fas fa-minus"></i> سحب
                    </button>
                </div>
            </div>

            <!-- حركة الخزنة -->
            <div class="list-card">
                <h3>حركة الخزنة</h3>
                <div class="table-responsive">
                    <table id="cashTable">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>الوقت</th>
                                <th>النوع</th>
                                <th>البيان</th>
                                <th>الوارد</th>
                                <th>المنصرف</th>
                                <th>الرصيد</th>
                                <th>بواسطة</th>
                            </tr>
                        </thead>
                        <tbody id="cashBody"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="4" class="text-left"><strong>الإجمالي:</strong></td>
                                <td id="totalCashIn"><strong>0</strong></td>
                                <td id="totalCashOut"><strong>0</strong></td>
                                <td id="finalCashBalance" colspan="2"><strong>0</strong></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- محتوى التاب - المصروفات -->
        <div id="expenses-tab" class="main-content tab-pane">
            <div class="section-header">
                <h2><i class="fas fa-file-invoice"></i> إدارة المصروفات</h2>
                <button class="btn btn-primary" onclick="inventory.showExpenseForm()">
                    <i class="fas fa-plus"></i> إضافة مصروف
                </button>
            </div>

            <div class="section-grid">
                <!-- إضافة مصروف -->
                <div class="form-card" id="expenseFormCard" style="display: none;">
                    <h3>إضافة مصروف جديد</h3>
                    <form id="expenseForm" onsubmit="inventory.addExpense(event)">
                        <div class="form-group">
                            <label>التاريخ</label>
                            <input type="date" id="expenseDate" required>
                        </div>
                        <div class="form-group">
                            <label>نوع المصروف</label>
                            <select id="expenseType" required>
                                <option value="rent">إيجار</option>
                                <option value="electricity">كهرباء</option>
                                <option value="water">مياه</option>
                                <option value="salaries">رواتب</option>
                                <option value="maintenance">صيانة</option>
                                <option value="other">أخرى</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label>المبلغ</label>
                            <input type="number" id="expenseAmount" step="0.01" min="0" required placeholder="أدخل المبلغ">
                        </div>
                        <div class="form-group">
                            <label>البيان</label>
                            <textarea id="expenseDescription" placeholder="وصف المصروف" required></textarea>
                        </div>
                        <div class="form-group">
                            <label>بواسطة</label>
                            <select id="expenseEmployee">
                                <option value="">اختر الموظف</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> حفظ المصروف
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="inventory.hideExpenseForm()">
                            <i class="fas fa-times"></i> إلغاء
                        </button>
                    </form>
                </div>

                <!-- قائمة المصروفات -->
                <div class="list-card">
                    <h3>سجل المصروفات</h3>
                    <div class="table-responsive">
                        <table id="expensesTable">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>النوع</th>
                                    <th>البيان</th>
                                    <th>المبلغ</th>
                                    <th>بواسطة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="expensesBody"></tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-left"><strong>إجمالي المصروفات:</strong></td>
                                    <td id="totalExpensesAmount" colspan="3"><strong>0</strong></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- محتوى التاب - الشركات -->
        <div id="companies-tab" class="main-content tab-pane">
            <div class="section-header">
                <h2><i class="fas fa-building"></i> إدارة الشركات</h2>
            </div>
            
            <div class="section-grid">
                <!-- إضافة شركة جديدة -->
                <div class="form-card">
                    <h3>إضافة شركة جديدة</h3>
                    <form id="companyForm" onsubmit="inventory.addCompany(event)">
                        <div class="form-group">
                            <label>اسم الشركة</label>
                            <input type="text" id="companyName" required placeholder="أدخل اسم الشركة">
                        </div>
                        <div class="form-group">
                            <label>رقم الهاتف</label>
                            <input type="text" id="companyPhone" placeholder="أدخل رقم الهاتف">
                        </div>
                        <div class="form-group">
                            <label>العنوان</label>
                            <textarea id="companyAddress" placeholder="أدخل العنوان"></textarea>
                        </div>
                        <div class="form-group">
                            <label>ملاحظات</label>
                            <textarea id="companyNotes" placeholder="ملاحظات إضافية"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> حفظ الشركة
                        </button>
                    </form>
                </div>

                <!-- قائمة الشركات -->
                <div class="list-card">
                    <h3>قائمة الشركات</h3>
                    <div id="companiesList" class="items-list"></div>
                </div>
            </div>
        </div>

        <!-- محتوى التاب - الأصناف -->
        <div id="categories-tab" class="main-content tab-pane">
            <div class="section-header">
                <h2><i class="fas fa-tags"></i> إدارة الأصناف</h2>
            </div>
            
            <div class="section-grid">
                <!-- إضافة صنف جديد -->
                <div class="form-card">
                    <h3>إضافة صنف جديد</h3>
                    <form id="categoryForm" onsubmit="inventory.addCategory(event)">
                        <div class="form-group">
                            <label>اسم الصنف</label>
                            <input type="text" id="categoryName" required placeholder="أدخل اسم الصنف">
                        </div>
                        <div class="form-group">
                            <label>وصف الصنف</label>
                            <textarea id="categoryDescription" placeholder="أدخل وصف الصنف"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> حفظ الصنف
                        </button>
                    </form>
                </div>

                <!-- قائمة الأصناف -->
                <div class="list-card">
                    <h3>قائمة الأصناف</h3>
                    <div id="categoriesList" class="items-list"></div>
                </div>
            </div>
        </div>

        <!-- أزرار التصدير -->
        <div style="margin-top: 20px;">
            <div class="export-buttons">
                <button class="btn btn-excel" onclick="inventory.exportToExcel('full')">
                    <i class="fas fa-file-excel"></i> تصدير Excel شامل
                </button>
                <button class="btn btn-excel" onclick="inventory.exportToExcel('summary')">
                    <i class="fas fa-chart-pie"></i> تصدير ملخص Excel
                </button>
                <button class="btn btn-pdf" onclick="inventory.exportToPDF()">
                    <i class="fas fa-file-pdf"></i> تصدير PDF
                </button>
                <button class="btn btn-print" onclick="inventory.printReport()">
                    <i class="fas fa-print"></i> طباعة التقرير
                </button>
                <button class="btn btn-backup" onclick="inventory.createBackup()">
                    <i class="fas fa-database"></i> نسخ احتياطي
                </button>
                <button class="btn btn-info" onclick="inventory.restoreFromBackupFile()">
                    <i class="fas fa-undo"></i> استعادة نسخة
                </button>
                <button class="btn btn-danger" onclick="inventory.clearAll()">
                    <i class="fas fa-trash"></i> مسح الكل
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة طباعة الفاتورة المخفية -->
    <div id="invoicePrint" style="display: none;"></div>

    <!-- مكان عرض رسائل التنبيه -->
    <div id="alert-container"></div>

    <!-- المكتبات الخارجية -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // نظام إدارة الذهب المتكامل - النسخة النهائية
        class GoldManagementSystem {
            constructor() {
                this.isScanning = false;
                this.currentFilters = {
                    company: 'all',
                    category: 'all',
                    goldType: 'all',
                    priceType: 'all'
                };
                this.selectedItemForSale = null;
                this.currentInvoiceNumber = 1;
                this.currentTab = 'inventory';
                this.currentInventoryTab = 'all';
                
                // تحميل البيانات
                this.loadData();
                
                // تهيئة النظام
                this.init();
                
                // إعداد المراقبة
                this.setupNetworkMonitoring();
                this.setupAutoSave();
                this.setupBeforeUnload();
            }

            // تحميل البيانات
            loadData() {
                try {
                    this.items = JSON.parse(localStorage.getItem('goldItems')) || [];
                    this.customers = JSON.parse(localStorage.getItem('customers')) || [];
                    this.employees = JSON.parse(localStorage.getItem('employees')) || [];
                    this.companies = JSON.parse(localStorage.getItem('companies')) || [];
                    this.categories = JSON.parse(localStorage.getItem('categories')) || [];
                    this.sales = JSON.parse(localStorage.getItem('sales')) || [];
                    this.cash = JSON.parse(localStorage.getItem('cash')) || [];
                    this.expenses = JSON.parse(localStorage.getItem('expenses')) || [];
                    this.mainGoldPrice21 = parseFloat(localStorage.getItem('mainGoldPrice21')) || 0;
                    this.lastInvoiceNumber = parseInt(localStorage.getItem('lastInvoiceNumber')) || 0;
                    
                    // التأكد من صحة البيانات
                    this.items = Array.isArray(this.items) ? this.items : [];
                    this.customers = Array.isArray(this.customers) ? this.customers : [];
                    this.employees = Array.isArray(this.employees) ? this.employees : [];
                    this.companies = Array.isArray(this.companies) ? this.companies : [];
                    this.categories = Array.isArray(this.categories) ? this.categories : [];
                    this.sales = Array.isArray(this.sales) ? this.sales : [];
                    this.cash = Array.isArray(this.cash) ? this.cash : [];
                    this.expenses = Array.isArray(this.expenses) ? this.expenses : [];
                    
                    // إضافة معرفات فريدة
                    this.items = this.items.map(item => ({
                        ...item,
                        id: item.id || Date.now() + Math.random(),
                        quantity: item.quantity || 1
                    }));

                } catch (e) {
                    console.error('خطأ في تحميل البيانات:', e);
                    this.items = [];
                    this.customers = [];
                    this.employees = [];
                    this.companies = [];
                    this.categories = [];
                    this.sales = [];
                    this.cash = [];
                    this.expenses = [];
                }
            }

            // تهيئة النظام
            init() {
                // تعيين التاريخ الحالي
                const today = new Date().toISOString().split('T')[0];
                document.getElementById('employeeHireDate') && (document.getElementById('employeeHireDate').value = today);
                document.getElementById('expenseDate') && (document.getElementById('expenseDate').value = today);
                
                // تحديث رقم الفاتورة
                this.currentInvoiceNumber = this.lastInvoiceNumber + 1;
                document.getElementById('invoiceNumber') && (document.getElementById('invoiceNumber').textContent = 
                    this.currentInvoiceNumber.toString().padStart(6, '0'));
                
                // عرض البيانات
                this.updateMainPriceDisplay();
                this.renderCompanies();
                this.renderCategories();
                this.renderCustomers();
                this.renderEmployees();
                this.renderCompanySelects();
                this.renderCategorySelects();
                this.renderCustomerSelects();
                this.renderEmployeeSelects();
                this.renderAllTables();
                this.renderSalesTable();
                this.renderCashTable();
                this.renderExpensesTable();
                this.renderCustomerSalesTable();
                this.renderEmployeeSalesTable();
                this.updateStats();
                this.updateCashBalance();
                
                // إعداد مستمعي الأحداث
                this.setupEventListeners();
            }

            // إعداد مستمعي الأحداث
            setupEventListeners() {
                // الباركود
                document.getElementById('barcodeInput')?.addEventListener('input', (e) => this.checkBarcodeDuplicate(e.target.value));
                
                // حساب السعر
                document.getElementById('weight')?.addEventListener('input', () => this.calculateTotalPrice());
                document.getElementById('goldType')?.addEventListener('change', () => this.calculateTotalPrice());
                document.getElementById('includeManufacturing')?.addEventListener('change', () => this.calculateTotalPrice());
                document.getElementById('wholesalePrice')?.addEventListener('change', () => this.calculateTotalPrice());
                document.getElementById('manufacturingPrice')?.addEventListener('input', () => this.calculateTotalPrice());
            }

            // مراقبة حالة الشبكة
            setupNetworkMonitoring() {
                window.addEventListener('online', () => {
                    document.getElementById('networkStatus').className = 'network-status online';
                    document.getElementById('networkStatus').innerHTML = '<i class="fas fa-wifi"></i><span>متصل بالإنترنت</span>';
                    this.showAlert('تم استعادة الاتصال بالإنترنت', 'success');
                });

                window.addEventListener('offline', () => {
                    document.getElementById('networkStatus').className = 'network-status offline';
                    document.getElementById('networkStatus').innerHTML = '<i class="fas fa-wifi-slash"></i><span>غير متصل بالإنترنت</span>';
                    this.showAlert('أنت الآن غير متصل بالإنترنت - يتم الحفظ محلياً', 'warning');
                });
            }

            // الحفظ التلقائي
            setupAutoSave() {
                setInterval(() => {
                    this.saveToLocalStorage(true);
                }, 30000);
            }

            // الحفظ قبل الإغلاق
            setupBeforeUnload() {
                window.addEventListener('beforeunload', () => {
                    this.saveToLocalStorage(true);
                });
            }

            // إظهار مؤشر الحفظ
            showAutoSaveIndicator() {
                const indicator = document.getElementById('autosaveIndicator');
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }

            // إظهار رسالة
            showAlert(message, type = 'success') {
                const alertContainer = document.getElementById('alert-container');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.innerHTML = `<i class="fas ${this.getAlertIcon(type)}"></i> ${message}`;
                alertContainer.innerHTML = '';
                alertContainer.appendChild(alert);
                
                setTimeout(() => {
                    alert.remove();
                }, 3000);
            }

            getAlertIcon(type) {
                const icons = {
                    success: 'fa-check-circle',
                    error: 'fa-exclamation-circle',
                    warning: 'fa-exclamation-triangle',
                    info: 'fa-info-circle'
                };
                return icons[type] || 'fa-info-circle';
            }

            // تبديل التاب الرئيسي
            switchMainTab(tabId) {
                document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.main-tab').forEach(btn => btn.classList.remove('active'));
                
                document.getElementById(`${tabId}-tab`).classList.add('active');
                const activeTab = document.querySelector(`[data-tab="${tabId}"]`);
                if (activeTab) activeTab.classList.add('active');
                
                this.currentTab = tabId;
            }

            // تبديل تبويب المخزون
            switchInventoryTab(tabId) {
                document.querySelectorAll('.tab-btn').forEach(btn => btn.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
                
                document.getElementById(`${tabId}-items`).classList.add('active');
                event.target.classList.add('active');
                
                this.currentInventoryTab = tabId;
            }

            // إنشاء باركود تلقائي
            generateBarcode() {
                const prefix = 'GLD';
                const timestamp = Date.now().toString().slice(-8);
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return `${prefix}${timestamp}${random}`;
            }

            // إنشاء رقم فاتورة
            generateInvoiceNumber() {
                this.lastInvoiceNumber++;
                localStorage.setItem('lastInvoiceNumber', this.lastInvoiceNumber);
                return this.lastInvoiceNumber.toString().padStart(6, '0');
            }

            // ================ دوال المخزون ================
            setMainGoldPrice() {
                const price = parseFloat(document.getElementById('mainGoldPrice').value);
                if (price && price > 0) {
                    this.mainGoldPrice21 = price;
                    localStorage.setItem('mainGoldPrice21', price);
                    this.showAlert(`تم تحديث سعر عيار 21 إلى ${price}`, 'success');
                    this.calculateTotalPrice();
                    this.recalculateAllPrices();
                } else {
                    this.showAlert('الرجاء إدخال سعر صحيح', 'error');
                }
            }

            updateMainPriceDisplay() {
                if (this.mainGoldPrice21 > 0) {
                    document.getElementById('mainGoldPrice').value = this.mainGoldPrice21;
                }
            }

            getGoldPriceByType(type) {
                if (type === 21) return this.mainGoldPrice21;
                if (type === 24) return this.mainGoldPrice21 * (24/21);
                if (type === 18) return this.mainGoldPrice21 * (18/21);
                return 0;
            }

            recalculateAllPrices() {
                this.items = this.items.map(item => {
                    const goldPricePerGram = this.getGoldPriceByType(item.goldType);
                    let goldTotal = item.weight * goldPricePerGram;
                    
                    if (item.wholesalePrice) {
                        goldTotal = goldTotal * 0.95;
                    }

                    let totalPrice = goldTotal;
                    if (item.includeManufacturing) {
                        totalPrice += item.manufacturingPrice;
                    }

                    return {
                        ...item,
                        goldPrice: goldPricePerGram,
                        totalPrice: totalPrice
                    };
                });

                this.saveToLocalStorage(true);
                this.renderAllTables();
            }

            calculateTotalPrice() {
                const weight = parseFloat(document.getElementById('weight').value) || 0;
                const goldType = parseInt(document.getElementById('goldType').value);
                const manufacturingPrice = parseFloat(document.getElementById('manufacturingPrice').value) || 0;
                const includeManufacturing = document.getElementById('includeManufacturing').checked;
                const wholesale = document.getElementById('wholesalePrice').checked;

                let goldPricePerGram = this.getGoldPriceByType(goldType);
                document.getElementById('goldPrice').value = goldPricePerGram.toFixed(2);

                let goldTotal = weight * goldPricePerGram;
                
                if (wholesale) {
                    goldTotal = goldTotal * 0.95;
                }

                let totalPrice = goldTotal;
                if (includeManufacturing) {
                    totalPrice += manufacturingPrice;
                }

                document.getElementById('totalSellingPrice').value = totalPrice.toFixed(2);
            }

            checkBarcodeDuplicate(barcode) {
                const warning = document.getElementById('barcodeDuplicateWarning');
                if (!barcode) {
                    warning.style.display = 'none';
                    return;
                }

                const existing = this.items.find(item => item.barcode === barcode);
                warning.style.display = existing ? 'flex' : 'none';
            }

            // تشغيل/إيقاف الماسح
            toggleScanner() {
                const scannerContainer = document.getElementById('scanner-container');
                const startBtn = document.getElementById('startScanner');

                if (!this.isScanning) {
                    scannerContainer.style.display = 'block';
                    startBtn.innerHTML = '<i class="fas fa-stop"></i> إيقاف الماسح';
                    this.startScanner();
                } else {
                    scannerContainer.style.display = 'none';
                    startBtn.innerHTML = '<i class="fas fa-play"></i> تشغيل الماسح';
                    this.stopScanner();
                }
                
                this.isScanning = !this.isScanning;
            }

            startScanner() {
                if (typeof Quagga === 'undefined') {
                    this.showAlert('خطأ في تحميل مكتبة الماسح الضوئي', 'error');
                    return;
                }

                Quagga.init({
                    inputStream: {
                        name: "Live",
                        type: "LiveStream",
                        target: document.querySelector('#scanner-video'),
                        constraints: {
                            width: 640,
                            height: 480,
                            facingMode: "environment"
                        },
                    },
                    decoder: {
                        readers: ["ean_reader", "ean_8_reader", "code_128_reader", "code_39_reader"]
                    }
                }, (err) => {
                    if (err) {
                        console.error('خطأ في تهيئة الماسح:', err);
                        this.showAlert('خطأ في تشغيل الكاميرا. تأكد من منح الصلاحيات', 'error');
                        return;
                    }
                    Quagga.start();
                });

                Quagga.onDetected((data) => {
                    const code = data.codeResult.code;
                    this.handleScannedBarcode(code);
                    this.stopScanner();
                    this.toggleScanner();
                });
            }

            stopScanner() {
                if (typeof Quagga !== 'undefined') {
                    Quagga.stop();
                }
            }

            handleScannedBarcode(barcode) {
                document.getElementById('barcode').value = barcode;
                document.getElementById('barcodeInput').value = barcode;
                
                const existingItem = this.items.find(item => item.barcode === barcode);
                if (existingItem) {
                    document.getElementById('itemName').value = existingItem.name;
                    document.getElementById('company').value = existingItem.company || '';
                    document.getElementById('category').value = existingItem.category || '';
                    document.getElementById('quantity').value = existingItem.quantity || 1;
                    document.getElementById('weight').value = existingItem.weight;
                    document.getElementById('goldType').value = existingItem.goldType;
                    document.getElementById('manufacturingPrice').value = existingItem.manufacturingPrice;
                    document.getElementById('notes').value = existingItem.notes || '';
                    document.getElementById('includeManufacturing').checked = existingItem.includeManufacturing !== false;
                    document.getElementById('wholesalePrice').checked = existingItem.wholesalePrice || false;
                    this.calculateTotalPrice();
                    
                    this.showAlert('تم العثور على القطعة! يمكنك تحديث البيانات', 'info');
                } else {
                    document.getElementById('itemName').focus();
                    this.calculateTotalPrice();
                }
            }

            addManualBarcode() {
                const barcode = document.getElementById('barcodeInput').value.trim();
                if (barcode) {
                    this.handleScannedBarcode(barcode);
                    document.getElementById('barcodeInput').value = '';
                } else {
                    this.showAlert('الرجاء إدخال الباركود', 'error');
                }
            }

            addItem(event) {
                event.preventDefault();

                let barcode = document.getElementById('barcode').value.trim();
                if (!barcode) {
                    barcode = this.generateBarcode();
                    document.getElementById('barcode').value = barcode;
                }

                const weight = parseFloat(document.getElementById('weight').value) || 0;
                if (weight <= 0) {
                    this.showAlert('الرجاء إدخال وزن صحيح', 'error');
                    return;
                }

                const company = document.getElementById('company').value;
                if (!company) {
                    this.showAlert('الرجاء اختيار الشركة', 'error');
                    return;
                }

                const category = document.getElementById('category').value;
                if (!category) {
                    this.showAlert('الرجاء اختيار الصنف', 'error');
                    return;
                }

                const quantity = parseInt(document.getElementById('quantity').value) || 1;

                const newItem = {
                    id: Date.now() + Math.random(),
                    barcode: barcode,
                    name: document.getElementById('itemName').value,
                    company: company,
                    companyName: this.getCompanyName(company),
                    category: category,
                    categoryName: this.getCategoryName(category),
                    quantity: quantity,
                    weight: weight,
                    goldType: parseInt(document.getElementById('goldType').value),
                    manufacturingPrice: parseFloat(document.getElementById('manufacturingPrice').value) || 0,
                    goldPrice: parseFloat(document.getElementById('goldPrice').value) || 0,
                    totalPrice: parseFloat(document.getElementById('totalSellingPrice').value) || 0,
                    includeManufacturing: document.getElementById('includeManufacturing').checked,
                    wholesalePrice: document.getElementById('wholesalePrice').checked,
                    notes: document.getElementById('notes').value,
                    date: new Date().toISOString()
                };

                const existingIndex = this.items.findIndex(item => item.barcode === barcode);
                if (existingIndex !== -1) {
                    this.items[existingIndex] = newItem;
                    this.showAlert('تم تحديث القطعة بنجاح', 'success');
                } else {
                    this.items.push(newItem);
                    this.showAlert('تم إضافة القطعة بنجاح', 'success');
                }

                this.saveToLocalStorage(true);
                this.renderAllTables();
                this.updateStats();
                this.resetForm();
                document.getElementById('barcodeDuplicateWarning').style.display = 'none';
            }

            deleteItem(id) {
                if (confirm('هل أنت متأكد من حذف هذه القطعة؟')) {
                    this.items = this.items.filter(item => item.id !== id);
                    this.saveToLocalStorage(true);
                    this.renderAllTables();
                    this.updateStats();
                    this.showAlert('تم حذف القطعة بنجاح', 'warning');
                }
            }

            editItem(id) {
                const item = this.items.find(item => item.id === id);
                if (item) {
                    document.getElementById('barcode').value = item.barcode;
                    document.getElementById('itemName').value = item.name;
                    document.getElementById('company').value = item.company;
                    document.getElementById('category').value = item.category;
                    document.getElementById('quantity').value = item.quantity || 1;
                    document.getElementById('weight').value = item.weight;
                    document.getElementById('goldType').value = item.goldType;
                    document.getElementById('manufacturingPrice').value = item.manufacturingPrice;
                    document.getElementById('notes').value = item.notes || '';
                    document.getElementById('includeManufacturing').checked = item.includeManufacturing !== false;
                    document.getElementById('wholesalePrice').checked = item.wholesalePrice || false;
                    this.calculateTotalPrice();

                    this.deleteItem(id);
                    this.showAlert('يمكنك تعديل البيانات الآن', 'info');
                    
                    this.switchMainTab('inventory');
                }
            }

            resetForm() {
                document.getElementById('itemForm').reset();
                document.getElementById('barcode').value = '';
                document.getElementById('quantity').value = '1';
                document.getElementById('includeManufacturing').checked = true;
                document.getElementById('wholesalePrice').checked = false;
                this.calculateTotalPrice();
            }

            // تطبيق الفلاتر
            applyFilters() {
                this.currentFilters = {
                    company: document.getElementById('filterCompany').value,
                    category: document.getElementById('filterCategory').value,
                    goldType: document.getElementById('filterGoldType').value,
                    priceType: document.getElementById('filterPriceType').value
                };

                this.renderAllTables();
            }

            clearFilters() {
                document.getElementById('filterCompany').value = 'all';
                document.getElementById('filterCategory').value = 'all';
                document.getElementById('filterGoldType').value = 'all';
                document.getElementById('filterPriceType').value = 'all';
                
                this.currentFilters = {
                    company: 'all',
                    category: 'all',
                    goldType: 'all',
                    priceType: 'all'
                };

                this.renderAllTables();
            }

            getFilteredItems() {
                return this.items.filter(item => {
                    if (this.currentFilters.company !== 'all' && item.company != this.currentFilters.company) return false;
                    if (this.currentFilters.category !== 'all' && item.category != this.currentFilters.category) return false;
                    if (this.currentFilters.goldType !== 'all' && item.goldType != this.currentFilters.goldType) return false;
                    if (this.currentFilters.priceType !== 'all') {
                        const isWholesale = this.currentFilters.priceType === 'wholesale';
                        if (item.wholesalePrice !== isWholesale) return false;
                    }
                    return true;
                });
            }

            // عرض الجداول
            renderAllTables() {
                const filteredItems = this.getFilteredItems();
                this.renderAllItemsTable(filteredItems);
                this.renderManufacturingTable(filteredItems);
                this.renderGoldTable(filteredItems);
            }

            renderAllItemsTable(items) {
                const tbody = document.getElementById('allItemsBody');
                const tfoot = document.getElementById('allItemsFooter');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                let totalWeight = 0;
                let totalManufacturing = 0;
                let totalGold = 0;
                let totalAll = 0;
                let totalQuantity = 0;

                items.forEach(item => {
                    totalWeight += item.weight * item.quantity;
                    totalManufacturing += item.manufacturingPrice * item.quantity;
                    totalGold += (item.weight * item.goldPrice) * item.quantity;
                    totalAll += item.totalPrice * item.quantity;
                    totalQuantity += item.quantity;

                    const row = tbody.insertRow();
                    const itemType = item.wholesalePrice ? 'جملة' : 'قطاعي';
                    row.innerHTML = `
                        <td>${item.barcode}</td>
                        <td>${item.name}</td>
                        <td>${item.companyName || 'غير معروف'}</td>
                        <td>${item.categoryName || 'غير معروف'}</td>
                        <td>${item.quantity}</td>
                        <td>${item.weight.toFixed(2)}g</td>
                        <td>${item.goldType}</td>
                        <td>${item.manufacturingPrice.toFixed(2)}</td>
                        <td>${item.goldPrice.toFixed(2)}</td>
                        <td>${itemType}</td>
                        <td>${(item.totalPrice * item.quantity).toFixed(2)}</td>
                        <td>
                            <button class="btn-edit btn-small" onclick="inventory.editItem(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete btn-small" onclick="inventory.deleteItem(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                            <button class="btn-success btn-small" onclick="inventory.quickSell(${item.id})">
                                <i class="fas fa-shopping-cart"></i>
                            </button>
                        </td>
                    `;
                });

                tfoot.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-left"><strong>الإجمالي:</strong></td>
                        <td><strong>${totalQuantity}</strong></td>
                        <td><strong>${totalWeight.toFixed(2)}g</strong></td>
                        <td></td>
                        <td><strong>${totalManufacturing.toFixed(2)}</strong></td>
                        <td></td>
                        <td></td>
                        <td><strong>${totalAll.toFixed(2)}</strong></td>
                        <td></td>
                    </tr>
                `;
            }

            renderManufacturingTable(items) {
                const tbody = document.getElementById('manufacturingBody');
                const tfoot = document.getElementById('manufacturingFooter');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                let totalManufacturing = 0;
                let totalWeight = 0;
                let totalQuantity = 0;

                items.forEach(item => {
                    totalManufacturing += item.manufacturingPrice * item.quantity;
                    totalWeight += item.weight * item.quantity;
                    totalQuantity += item.quantity;

                    const itemType = item.wholesalePrice ? 'جملة' : 'قطاعي';
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${item.barcode}</td>
                        <td>${item.name}</td>
                        <td>${item.companyName || 'غير معروف'}</td>
                        <td>${item.categoryName || 'غير معروف'}</td>
                        <td>${item.quantity}</td>
                        <td>${item.weight.toFixed(2)}g</td>
                        <td>${item.goldType}</td>
                        <td>${(item.manufacturingPrice * item.quantity).toFixed(2)}</td>
                        <td>${itemType}</td>
                        <td>
                            <button class="btn-edit btn-small" onclick="inventory.editItem(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete btn-small" onclick="inventory.deleteItem(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                });

                tfoot.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-left"><strong>الإجمالي:</strong></td>
                        <td><strong>${totalQuantity}</strong></td>
                        <td><strong>${totalWeight.toFixed(2)}g</strong></td>
                        <td></td>
                        <td><strong>${totalManufacturing.toFixed(2)}</strong></td>
                        <td></td>
                        <td></td>
                    </tr>
                `;
            }

            renderGoldTable(items) {
                const tbody = document.getElementById('goldBody');
                const tfoot = document.getElementById('goldFooter');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                let totalGold = 0;
                let totalWeight = 0;
                let totalQuantity = 0;

                items.forEach(item => {
                    totalGold += (item.weight * item.goldPrice) * item.quantity;
                    totalWeight += item.weight * item.quantity;
                    totalQuantity += item.quantity;

                    const itemType = item.wholesalePrice ? 'جملة' : 'قطاعي';
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${item.barcode}</td>
                        <td>${item.name}</td>
                        <td>${item.companyName || 'غير معروف'}</td>
                        <td>${item.categoryName || 'غير معروف'}</td>
                        <td>${item.quantity}</td>
                        <td>${item.weight.toFixed(2)}g</td>
                        <td>${item.goldType}</td>
                        <td>${item.goldPrice.toFixed(2)}</td>
                        <td>${itemType}</td>
                        <td>
                            <button class="btn-edit btn-small" onclick="inventory.editItem(${item.id})">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn-delete btn-small" onclick="inventory.deleteItem(${item.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                });

                tfoot.innerHTML = `
                    <tr>
                        <td colspan="4" class="text-left"><strong>الإجمالي:</strong></td>
                        <td><strong>${totalQuantity}</strong></td>
                        <td><strong>${totalWeight.toFixed(2)}g</strong></td>
                        <td></td>
                        <td><strong>${totalGold.toFixed(2)}</strong></td>
                        <td></td>
                        <td></td>
                    </tr>
                `;
            }

            quickSell(id) {
                const item = this.items.find(i => i.id === id);
                if (item) {
                    this.switchMainTab('sales');
                    document.getElementById('sellBarcode').value = item.barcode;
                    this.searchItemForSale(item.barcode);
                }
            }

            searchItems(query, tableType) {
                query = query.toLowerCase();
                let filteredItems = this.getFilteredItems();

                if (query) {
                    filteredItems = filteredItems.filter(item => 
                        item.name.toLowerCase().includes(query) || 
                        item.barcode.toLowerCase().includes(query) ||
                        (item.companyName && item.companyName.toLowerCase().includes(query)) ||
                        (item.categoryName && item.categoryName.toLowerCase().includes(query))
                    );
                }

                switch(tableType) {
                    case 'all':
                        this.renderAllItemsTable(filteredItems);
                        break;
                    case 'manufacturing':
                        this.renderManufacturingTable(filteredItems);
                        break;
                    case 'gold':
                        this.renderGoldTable(filteredItems);
                        break;
                }
            }

            // ================ دوال العملاء ================
            addCustomer(event) {
                event.preventDefault();

                const customer = {
                    id: Date.now() + Math.random(),
                    name: document.getElementById('customerName').value,
                    phone: document.getElementById('customerPhone').value,
                    email: document.getElementById('customerEmail').value,
                    address: document.getElementById('customerAddress').value,
                    notes: document.getElementById('customerNotes').value,
                    date: new Date().toISOString(),
                    totalPurchases: 0,
                    purchaseCount: 0,
                    lastPurchase: null
                };

                this.customers.push(customer);
                localStorage.setItem('customers', JSON.stringify(this.customers));
                
                this.renderCustomers();
                this.renderCustomerSelects();
                this.renderCustomerSalesTable();
                document.getElementById('customerForm').reset();
                this.showAlert('تم إضافة العميل بنجاح', 'success');
            }

            deleteCustomer(id) {
                if (confirm('هل أنت متأكد من حذف هذا العميل؟')) {
                    this.customers = this.customers.filter(c => c.id !== id);
                    localStorage.setItem('customers', JSON.stringify(this.customers));
                    this.renderCustomers();
                    this.renderCustomerSelects();
                    this.renderCustomerSalesTable();
                    this.showAlert('تم حذف العميل بنجاح', 'warning');
                }
            }

            renderCustomers() {
                const list = document.getElementById('customersList');
                if (!list) return;
                
                list.innerHTML = '';

                this.customers.forEach(customer => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div class="item-info">
                            <h4>${customer.name}</h4>
                            <p><i class="fas fa-phone"></i> ${customer.phone || 'لا يوجد هاتف'}</p>
                            <p><i class="fas fa-envelope"></i> ${customer.email || 'لا يوجد بريد'}</p>
                            <p><i class="fas fa-map-marker-alt"></i> ${customer.address || 'لا يوجد عنوان'}</p>
                            <small>آخر شراء: ${customer.lastPurchase || 'لم يشتري بعد'}</small>
                        </div>
                        <div class="item-actions">
                            <button class="btn-delete" onclick="inventory.deleteCustomer(${customer.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            renderCustomerSelects() {
                const select = document.getElementById('sellCustomer');
                if (!select) return;
                
                select.innerHTML = '<option value="">اختر العميل</option>';
                
                this.customers.forEach(customer => {
                    const option = document.createElement('option');
                    option.value = customer.id;
                    option.textContent = customer.name;
                    select.appendChild(option);
                });
            }

            renderCustomerSalesTable() {
                const tbody = document.getElementById('customerSalesBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                this.customers.forEach(customer => {
                    const customerSales = this.sales.filter(s => s.customerId == customer.id);
                    const totalAmount = customerSales.reduce((sum, s) => sum + s.totalPrice, 0);
                    const lastSale = customerSales.length > 0 ? 
                        customerSales.sort((a, b) => new Date(b.date) - new Date(a.date))[0].date : 'لا يوجد';

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${customer.name}</td>
                        <td>${customerSales.length}</td>
                        <td>${totalAmount.toFixed(2)}</td>
                        <td>${lastSale}</td>
                    `;
                });
            }

            // ================ دوال الموظفين ================
            addEmployee(event) {
                event.preventDefault();

                const employee = {
                    id: Date.now() + Math.random(),
                    name: document.getElementById('employeeName').value,
                    phone: document.getElementById('employeePhone').value,
                    position: document.getElementById('employeePosition').value,
                    salary: parseFloat(document.getElementById('employeeSalary').value) || 0,
                    hireDate: document.getElementById('employeeHireDate').value,
                    notes: document.getElementById('employeeNotes').value,
                    totalSales: 0,
                    salesCount: 0,
                    date: new Date().toISOString()
                };

                this.employees.push(employee);
                localStorage.setItem('employees', JSON.stringify(this.employees));
                
                this.renderEmployees();
                this.renderEmployeeSelects();
                this.renderEmployeeSalesTable();
                document.getElementById('employeeForm').reset();
                document.getElementById('employeeHireDate').value = new Date().toISOString().split('T')[0];
                this.showAlert('تم إضافة الموظف بنجاح', 'success');
            }

            deleteEmployee(id) {
                if (confirm('هل أنت متأكد من حذف هذا الموظف؟')) {
                    this.employees = this.employees.filter(e => e.id !== id);
                    localStorage.setItem('employees', JSON.stringify(this.employees));
                    this.renderEmployees();
                    this.renderEmployeeSelects();
                    this.renderEmployeeSalesTable();
                    this.showAlert('تم حذف الموظف بنجاح', 'warning');
                }
            }

            renderEmployees() {
                const list = document.getElementById('employeesList');
                if (!list) return;
                
                list.innerHTML = '';

                this.employees.forEach(employee => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div class="item-info">
                            <h4>${employee.name}</h4>
                            <p><i class="fas fa-phone"></i> ${employee.phone || 'لا يوجد هاتف'}</p>
                            <p><i class="fas fa-briefcase"></i> ${employee.position || 'لا يوجد'}</p>
                            <p><i class="fas fa-money-bill"></i> الراتب: ${employee.salary}</p>
                            <p><i class="fas fa-chart-line"></i> مبيعات: ${employee.salesCount} | إجمالي: ${employee.totalSales.toFixed(2)}</p>
                        </div>
                        <div class="item-actions">
                            <button class="btn-delete" onclick="inventory.deleteEmployee(${employee.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            renderEmployeeSelects() {
                const selects = ['sellEmployee', 'expenseEmployee'];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">اختر الموظف</option>';
                        
                        this.employees.forEach(employee => {
                            const option = document.createElement('option');
                            option.value = employee.id;
                            option.textContent = employee.name;
                            select.appendChild(option);
                        });
                    }
                });
            }

            renderEmployeeSalesTable() {
                const tbody = document.getElementById('employeeSalesBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';

                this.employees.forEach(employee => {
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${employee.name}</td>
                        <td>${employee.salesCount}</td>
                        <td>${employee.totalSales.toFixed(2)}</td>
                        <td>${employee.salary}</td>
                    `;
                });
            }

            // ================ دوال الشركات والأصناف ================
            addCompany(event) {
                event.preventDefault();

                const company = {
                    id: Date.now() + Math.random(),
                    name: document.getElementById('companyName').value,
                    phone: document.getElementById('companyPhone').value,
                    address: document.getElementById('companyAddress').value,
                    notes: document.getElementById('companyNotes').value,
                    date: new Date().toISOString()
                };

                this.companies.push(company);
                localStorage.setItem('companies', JSON.stringify(this.companies));
                
                this.renderCompanies();
                this.renderCompanySelects();
                document.getElementById('companyForm').reset();
                this.showAlert('تم إضافة الشركة بنجاح', 'success');
            }

            deleteCompany(id) {
                if (confirm('هل أنت متأكد من حذف هذه الشركة؟')) {
                    this.companies = this.companies.filter(c => c.id !== id);
                    localStorage.setItem('companies', JSON.stringify(this.companies));
                    this.renderCompanies();
                    this.renderCompanySelects();
                    this.showAlert('تم حذف الشركة بنجاح', 'warning');
                }
            }

            renderCompanies() {
                const list = document.getElementById('companiesList');
                if (!list) return;
                
                list.innerHTML = '';

                this.companies.forEach(company => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div class="item-info">
                            <h4>${company.name}</h4>
                            <p><i class="fas fa-phone"></i> ${company.phone || 'لا يوجد هاتف'}</p>
                            <p><i class="fas fa-map-marker-alt"></i> ${company.address || 'لا يوجد عنوان'}</p>
                            <small>${company.notes || ''}</small>
                        </div>
                        <div class="item-actions">
                            <button class="btn-delete" onclick="inventory.deleteCompany(${company.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            renderCompanySelects() {
                const selects = ['company', 'filterCompany', 'searchProductCompany'];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = selectId.includes('filter') || selectId.includes('search') ? 
                            '<option value="all">جميع الشركات</option>' : 
                            '<option value="">اختر الشركة</option>';
                        
                        this.companies.forEach(company => {
                            const option = document.createElement('option');
                            option.value = company.id;
                            option.textContent = company.name;
                            select.appendChild(option);
                        });
                    }
                });
            }

            addCategory(event) {
                event.preventDefault();

                const category = {
                    id: Date.now() + Math.random(),
                    name: document.getElementById('categoryName').value,
                    description: document.getElementById('categoryDescription').value,
                    date: new Date().toISOString()
                };

                this.categories.push(category);
                localStorage.setItem('categories', JSON.stringify(this.categories));
                
                this.renderCategories();
                this.renderCategorySelects();
                document.getElementById('categoryForm').reset();
                this.showAlert('تم إضافة الصنف بنجاح', 'success');
            }

            deleteCategory(id) {
                if (confirm('هل أنت متأكد من حذف هذا الصنف؟')) {
                    this.categories = this.categories.filter(c => c.id !== id);
                    localStorage.setItem('categories', JSON.stringify(this.categories));
                    this.renderCategories();
                    this.renderCategorySelects();
                    this.showAlert('تم حذف الصنف بنجاح', 'warning');
                }
            }

            renderCategories() {
                const list = document.getElementById('categoriesList');
                if (!list) return;
                
                list.innerHTML = '';

                this.categories.forEach(category => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div class="item-info">
                            <h4>${category.name}</h4>
                            <p>${category.description || ''}</p>
                        </div>
                        <div class="item-actions">
                            <button class="btn-delete" onclick="inventory.deleteCategory(${category.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            renderCategorySelects() {
                const selects = ['category', 'filterCategory', 'searchProductCategory'];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = selectId.includes('filter') || selectId.includes('search') ? 
                            '<option value="all">جميع الأصناف</option>' : 
                            '<option value="">اختر الصنف</option>';
                        
                        this.categories.forEach(category => {
                            const option = document.createElement('option');
                            option.value = category.id;
                            option.textContent = category.name;
                            select.appendChild(option);
                        });
                    }
                });
            }

            // ================ دوال الخزنة ================
            getCashBalance() {
                let balance = 0;
                this.cash.forEach(transaction => {
                    if (transaction.type === 'in') balance += transaction.amount;
                    else if (transaction.type === 'out') balance -= transaction.amount;
                });
                return balance;
            }

            addCashTransaction(type, amount, description, employeeId = null, relatedId = null) {
                const balance = this.getCashBalance();
                const transaction = {
                    id: Date.now() + Math.random(),
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toLocaleTimeString('ar-EG'),
                    type: type,
                    amount: amount,
                    description: description,
                    employeeId: employeeId,
                    employeeName: employeeId ? this.getEmployeeName(employeeId) : 'النظام',
                    relatedId: relatedId,
                    balance: balance + (type === 'in' ? amount : -amount)
                };

                this.cash.push(transaction);
                localStorage.setItem('cash', JSON.stringify(this.cash));
                this.renderCashTable();
                this.updateCashBalance();
                return transaction;
            }

            addToCash() {
                const amount = parseFloat(prompt('أدخل المبلغ المراد إيداعه:'));
                if (amount && amount > 0) {
                    const description = prompt('أدخل البيان:') || 'إيداع';
                    this.addCashTransaction('in', amount, description);
                    this.showAlert('تم إضافة المبلغ إلى الخزنة', 'success');
                }
            }

            withdrawFromCash() {
                const amount = parseFloat(prompt('أدخل المبلغ المراد سحبه:'));
                if (amount && amount > 0) {
                    if (amount > this.getCashBalance()) {
                        this.showAlert('الرصيد غير كافي', 'error');
                        return;
                    }
                    const description = prompt('أدخل البيان:') || 'سحب';
                    this.addCashTransaction('out', amount, description);
                    this.showAlert('تم سحب المبلغ من الخزنة', 'success');
                }
            }

            renderCashTable() {
                const tbody = document.getElementById('cashBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                let totalIn = 0;
                let totalOut = 0;
                let balance = 0;

                this.cash.sort((a, b) => new Date(b.date + ' ' + b.time) - new Date(a.date + ' ' + a.time)).forEach(transaction => {
                    if (transaction.type === 'in') {
                        totalIn += transaction.amount;
                        balance += transaction.amount;
                    } else {
                        totalOut += transaction.amount;
                        balance -= transaction.amount;
                    }

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${transaction.date}</td>
                        <td>${transaction.time}</td>
                        <td><span class="badge ${transaction.type === 'in' ? 'badge-success' : 'badge-danger'}">${transaction.type === 'in' ? 'وارد' : 'منصرف'}</span></td>
                        <td>${transaction.description}</td>
                        <td>${transaction.type === 'in' ? transaction.amount.toFixed(2) : '-'}</td>
                        <td>${transaction.type === 'out' ? transaction.amount.toFixed(2) : '-'}</td>
                        <td>${balance.toFixed(2)}</td>
                        <td>${transaction.employeeName}</td>
                    `;
                });

                document.getElementById('totalCashIn').innerHTML = `<strong>${totalIn.toFixed(2)}</strong>`;
                document.getElementById('totalCashOut').innerHTML = `<strong>${totalOut.toFixed(2)}</strong>`;
                document.getElementById('finalCashBalance').innerHTML = `<strong>${balance.toFixed(2)}</strong>`;
            }

            updateCashBalance() {
                const balance = this.getCashBalance();
                document.getElementById('currentCash').textContent = balance.toFixed(2);
                document.getElementById('cashBalance').textContent = balance.toFixed(2);
                document.getElementById('lastCashUpdate').textContent = new Date().toLocaleTimeString('ar-EG');
            }

            // ================ دوال المصروفات ================
            showExpenseForm() {
                document.getElementById('expenseFormCard').style.display = 'block';
            }

            hideExpenseForm() {
                document.getElementById('expenseFormCard').style.display = 'none';
            }

            addExpense(event) {
                event.preventDefault();

                const amount = parseFloat(document.getElementById('expenseAmount').value);
                if (amount > this.getCashBalance()) {
                    this.showAlert('الرصيد غير كافي', 'error');
                    return;
                }

                const expense = {
                    id: Date.now() + Math.random(),
                    date: document.getElementById('expenseDate').value,
                    type: document.getElementById('expenseType').value,
                    amount: amount,
                    description: document.getElementById('expenseDescription').value,
                    employeeId: document.getElementById('expenseEmployee').value,
                    employeeName: this.getEmployeeName(document.getElementById('expenseEmployee').value),
                    timestamp: new Date().toISOString()
                };

                this.expenses.push(expense);
                localStorage.setItem('expenses', JSON.stringify(this.expenses));

                this.addCashTransaction('out', expense.amount, `مصروف: ${expense.description}`, expense.employeeId, expense.id);

                this.renderExpensesTable();
                document.getElementById('expenseForm').reset();
                document.getElementById('expenseDate').value = new Date().toISOString().split('T')[0];
                this.hideExpenseForm();
                this.showAlert('تم إضافة المصروف بنجاح', 'success');
            }

            deleteExpense(id) {
                if (confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
                    this.expenses = this.expenses.filter(e => e.id !== id);
                    localStorage.setItem('expenses', JSON.stringify(this.expenses));
                    this.renderExpensesTable();
                    this.showAlert('تم حذف المصروف بنجاح', 'warning');
                }
            }

            renderExpensesTable() {
                const tbody = document.getElementById('expensesBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                let totalExpenses = 0;

                this.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                    totalExpenses += expense.amount;
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${expense.date}</td>
                        <td>${this.getExpenseTypeName(expense.type)}</td>
                        <td>${expense.description}</td>
                        <td>${expense.amount.toFixed(2)}</td>
                        <td>${expense.employeeName || 'غير معروف'}</td>
                        <td>
                            <button class="btn-delete btn-small" onclick="inventory.deleteExpense(${expense.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                });

                document.getElementById('totalExpenses').textContent = totalExpenses.toFixed(2);
                document.getElementById('totalExpensesAmount').innerHTML = `<strong>${totalExpenses.toFixed(2)}</strong>`;
                document.getElementById('totalSalaries').textContent = this.calculateTotalSalaries().toFixed(2);
            }

            getExpenseTypeName(type) {
                const types = {
                    rent: 'إيجار',
                    electricity: 'كهرباء',
                    water: 'مياه',
                    salaries: 'رواتب',
                    maintenance: 'صيانة',
                    other: 'أخرى'
                };
                return types[type] || type;
            }

            calculateTotalSalaries() {
                const currentMonth = new Date().getMonth();
                const currentYear = new Date().getFullYear();
                
                return this.expenses
                    .filter(e => e.type === 'salaries' && new Date(e.date).getMonth() === currentMonth && new Date(e.date).getFullYear() === currentYear)
                    .reduce((sum, e) => sum + e.amount, 0);
            }

            // ================ دوال المبيعات ================
            searchItemForSale(barcode) {
                const stockInfo = document.getElementById('stockInfo');
                if (!barcode) {
                    this.selectedItemForSale = null;
                    stockInfo.innerHTML = '';
                    document.getElementById('sellPrice').value = '';
                    document.getElementById('sellTotal').value = '';
                    return;
                }

                const item = this.items.find(i => i.barcode === barcode);
                if (item) {
                    this.selectedItemForSale = item;
                    stockInfo.innerHTML = `
                        <strong>${item.name}</strong><br>
                        المتوفر: ${item.quantity} | الوزن: ${item.weight}g | السعر: ${item.totalPrice}
                    `;
                    document.getElementById('sellPrice').value = item.totalPrice;
                    document.getElementById('sellQuantity').max = item.quantity;
                    this.updateSaleTotal();
                } else {
                    this.selectedItemForSale = null;
                    stockInfo.innerHTML = 'القطعة غير موجودة في المخزون';
                    document.getElementById('sellPrice').value = '';
                    document.getElementById('sellTotal').value = '';
                }
            }

            adjustQuantity(change) {
                const input = document.getElementById('sellQuantity');
                let value = parseInt(input.value) || 1;
                value += change;
                if (value < 1) value = 1;
                if (this.selectedItemForSale && value > this.selectedItemForSale.quantity) {
                    value = this.selectedItemForSale.quantity;
                    this.showAlert('الكمية المتاحة: ' + this.selectedItemForSale.quantity, 'warning');
                }
                input.value = value;
                this.updateSaleTotal();
            }

            updateSaleTotal() {
                const price = parseFloat(document.getElementById('sellPrice').value) || 0;
                const quantity = parseInt(document.getElementById('sellQuantity').value) || 1;
                document.getElementById('sellTotal').value = (price * quantity).toFixed(2);
            }

            processSale(event) {
                event.preventDefault();

                if (!this.selectedItemForSale) {
                    this.showAlert('الرجاء اختيار قطعة صالحة', 'error');
                    return;
                }

                const customerId = document.getElementById('sellCustomer').value;
                if (!customerId) {
                    this.showAlert('الرجاء اختيار العميل', 'error');
                    return;
                }

                const employeeId = document.getElementById('sellEmployee').value;
                if (!employeeId) {
                    this.showAlert('الرجاء اختيار الموظف', 'error');
                    return;
                }

                const quantity = parseInt(document.getElementById('sellQuantity').value) || 1;
                if (quantity > this.selectedItemForSale.quantity) {
                    this.showAlert('الكمية المطلوبة أكبر من المتوفر', 'error');
                    return;
                }

                const invoiceNumber = this.generateInvoiceNumber();
                const totalPrice = this.selectedItemForSale.totalPrice * quantity;

                const sale = {
                    id: Date.now() + Math.random(),
                    invoiceNumber: invoiceNumber,
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toLocaleTimeString('ar-EG'),
                    barcode: this.selectedItemForSale.barcode,
                    itemName: this.selectedItemForSale.name,
                    itemId: this.selectedItemForSale.id,
                    customerId: customerId,
                    customerName: this.getCustomerName(customerId),
                    employeeId: employeeId,
                    employeeName: this.getEmployeeName(employeeId),
                    quantity: quantity,
                    weight: this.selectedItemForSale.weight,
                    unitPrice: this.selectedItemForSale.totalPrice,
                    totalPrice: totalPrice,
                    paymentMethod: document.getElementById('sellPayment').value,
                    notes: document.getElementById('sellNotes').value,
                    status: 'completed',
                    timestamp: new Date().toISOString()
                };

                // تحديث المخزون
                const itemIndex = this.items.findIndex(i => i.id === this.selectedItemForSale.id);
                if (itemIndex !== -1) {
                    this.items[itemIndex].quantity -= quantity;
                    if (this.items[itemIndex].quantity <= 0) {
                        this.items.splice(itemIndex, 1);
                    }
                }

                // تحديث العميل
                const customerIndex = this.customers.findIndex(c => c.id == customerId);
                if (customerIndex !== -1) {
                    this.customers[customerIndex].purchaseCount = (this.customers[customerIndex].purchaseCount || 0) + 1;
                    this.customers[customerIndex].totalPurchases = (this.customers[customerIndex].totalPurchases || 0) + totalPrice;
                    this.customers[customerIndex].lastPurchase = sale.date;
                }

                // تحديث الموظف
                const employeeIndex = this.employees.findIndex(e => e.id == employeeId);
                if (employeeIndex !== -1) {
                    this.employees[employeeIndex].totalSales = (this.employees[employeeIndex].totalSales || 0) + totalPrice;
                    this.employees[employeeIndex].salesCount = (this.employees[employeeIndex].salesCount || 0) + 1;
                }

                // إضافة إلى الخزنة
                this.addCashTransaction('in', totalPrice, `فاتورة رقم: ${invoiceNumber} - ${sale.itemName}`, employeeId, sale.id);

                // حفظ المبيعة
                this.sales.push(sale);
                localStorage.setItem('sales', JSON.stringify(this.sales));
                localStorage.setItem('customers', JSON.stringify(this.customers));
                localStorage.setItem('employees', JSON.stringify(this.employees));

                this.saveToLocalStorage(true);
                this.renderAllTables();
                this.renderSalesTable();
                this.renderEmployees();
                this.renderCustomers();
                this.renderCustomerSalesTable();
                this.renderEmployeeSalesTable();
                this.updateStats();
                this.resetSellForm();
                
                // تحديث رقم الفاتورة في الواجهة
                document.getElementById('invoiceNumber').textContent = this.generateInvoiceNumber().toString().padStart(6, '0');
                
                this.showAlert(`تمت عملية البيع بنجاح - فاتورة رقم: ${invoiceNumber}`, 'success');
                
                // عرض الفاتورة
                this.showInvoice(sale);
            }

            showInvoice(sale) {
                const invoiceHtml = this.generateInvoiceHtml(sale);
                const printWindow = window.open('', '_blank');
                printWindow.document.write(invoiceHtml);
                printWindow.document.close();
            }

            generateInvoiceHtml(sale) {
                return `
                    <!DOCTYPE html>
                    <html dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>فاتورة رقم ${sale.invoiceNumber}</title>
                        <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
                        <style>
                            body { font-family: 'Tajawal', sans-serif; padding: 20px; background: #f5f5f5; }
                            .invoice-container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
                            .invoice-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #d4af37; padding-bottom: 20px; }
                            .invoice-header h1 { color: #d4af37; font-size: 32px; margin-bottom: 10px; }
                            .invoice-header h2 { color: #8b7355; font-size: 24px; }
                            .invoice-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
                            .info-item { background: #f8f9fa; padding: 15px; border-radius: 8px; border-right: 3px solid #d4af37; }
                            .info-item strong { color: #8b7355; display: block; margin-bottom: 5px; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th { background: #d4af37; color: white; padding: 12px; }
                            td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
                            .total-row { background: #e8f5e9; font-weight: 700; font-size: 18px; }
                            .footer { margin-top: 40px; text-align: center; color: #666; border-top: 1px solid #ddd; padding-top: 20px; }
                            .developer { color: #6f42c1; font-weight: 700; }
                            .whatsapp { color: #25d366; }
                            @media print {
                                body { background: white; }
                                .invoice-container { box-shadow: none; padding: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="invoice-container">
                            <div class="invoice-header">
                                <h1>نظام إدارة الذهب المتكامل</h1>
                                <h2>فاتورة بيع</h2>
                            </div>
                            
                            <div class="invoice-info">
                                <div class="info-item">
                                    <strong>رقم الفاتورة:</strong>
                                    <span>${sale.invoiceNumber}</span>
                                </div>
                                <div class="info-item">
                                    <strong>تاريخ الفاتورة:</strong>
                                    <span>${sale.date}</span>
                                </div>
                                <div class="info-item">
                                    <strong>العميل:</strong>
                                    <span>${sale.customerName}</span>
                                </div>
                                <div class="info-item">
                                    <strong>الموظف:</strong>
                                    <span>${sale.employeeName}</span>
                                </div>
                                <div class="info-item">
                                    <strong>طريقة الدفع:</strong>
                                    <span>${sale.paymentMethod === 'cash' ? 'نقدي' : sale.paymentMethod === 'card' ? 'بطاقة' : 'تحويل بنكي'}</span>
                                </div>
                                <div class="info-item">
                                    <strong>وقت الفاتورة:</strong>
                                    <span>${sale.time}</span>
                                </div>
                            </div>

                            <table>
                                <thead>
                                    <tr>
                                        <th>الباركود</th>
                                        <th>القطعة</th>
                                        <th>الكمية</th>
                                        <th>الوزن</th>
                                        <th>سعر الوحدة</th>
                                        <th>الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>${sale.barcode}</td>
                                        <td>${sale.itemName}</td>
                                        <td>${sale.quantity}</td>
                                        <td>${sale.weight}g</td>
                                        <td>${sale.unitPrice.toFixed(2)}</td>
                                        <td>${sale.totalPrice.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td colspan="5" style="text-align: left;">الإجمالي الكلي:</td>
                                        <td>${sale.totalPrice.toFixed(2)}</td>
                                    </tr>
                                </tfoot>
                            </table>

                            <div class="footer">
                                <p>شكراً لتعاملكم معنا</p>
                                <p>تم التطوير بواسطة <span class="developer">محمد أحمد فؤاد</span> | 
                                   <span class="whatsapp">واتساب: +201010421571</span></p>
                                <p>جميع الحقوق محفوظة © ${new Date().getFullYear()}</p>
                            </div>
                            
                            <div class="no-print" style="text-align: center; margin-top: 20px;">
                                <button onclick="window.print()" style="padding: 10px 20px; background: #d4af37; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">طباعة</button>
                                <button onclick="window.close()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">إغلاق</button>
                            </div>
                        </div>
                    </body>
                    </html>
                `;
            }

            printInvoice() {
                if (!this.selectedItemForSale) {
                    this.showAlert('الرجاء اختيار قطعة أولاً', 'error');
                    return;
                }
                document.getElementById('sellForm').dispatchEvent(new Event('submit'));
            }

            showReturns() {
                const returnSection = document.getElementById('returnSection');
                returnSection.style.display = returnSection.style.display === 'none' ? 'block' : 'none';
            }

            processReturn(event) {
                event.preventDefault();

                const invoiceNumber = document.getElementById('returnInvoice').value;
                const reason = document.getElementById('returnReason').value;
                const quantity = parseInt(document.getElementById('returnQuantity').value) || 1;

                const sale = this.sales.find(s => s.invoiceNumber === invoiceNumber);
                if (!sale) {
                    this.showAlert('رقم الفاتورة غير موجود', 'error');
                    return;
                }

                if (sale.status === 'returned') {
                    this.showAlert('هذه الفاتورة مرتجعة مسبقاً', 'error');
                    return;
                }

                if (quantity > sale.quantity) {
                    this.showAlert('الكمية المرتجعة أكبر من الكمية المباعة', 'error');
                    return;
                }

                // إعادة القطعة للمخزون
                const existingItem = this.items.find(i => i.barcode === sale.barcode);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    this.items.push({
                        id: sale.itemId || Date.now() + Math.random(),
                        barcode: sale.barcode,
                        name: sale.itemName,
                        quantity: quantity,
                        weight: sale.weight,
                        company: '',
                        category: '',
                        goldType: 21,
                        manufacturingPrice: 0,
                        goldPrice: 0,
                        totalPrice: sale.unitPrice,
                        includeManufacturing: true,
                        wholesalePrice: false,
                        date: new Date().toISOString()
                    });
                }

                // تحديث المبيعة
                sale.status = quantity === sale.quantity ? 'returned' : 'partially_returned';
                sale.returnReason = reason;
                sale.returnDate = new Date().toISOString().split('T')[0];

                // سحب المبلغ من الخزنة
                const returnAmount = sale.unitPrice * quantity;
                this.addCashTransaction('out', returnAmount, `مرتجع فاتورة رقم: ${invoiceNumber}`, null, sale.id);

                // تحديث إحصائيات العميل
                const customerIndex = this.customers.findIndex(c => c.id == sale.customerId);
                if (customerIndex !== -1) {
                    this.customers[customerIndex].totalPurchases -= returnAmount;
                    if (quantity === sale.quantity) {
                        this.customers[customerIndex].purchaseCount--;
                    }
                }

                // تحديث إحصائيات الموظف
                if (sale.employeeId) {
                    const employeeIndex = this.employees.findIndex(e => e.id == sale.employeeId);
                    if (employeeIndex !== -1) {
                        this.employees[employeeIndex].totalSales -= returnAmount;
                        if (quantity === sale.quantity) {
                            this.employees[employeeIndex].salesCount--;
                        }
                    }
                }

                localStorage.setItem('sales', JSON.stringify(this.sales));
                localStorage.setItem('customers', JSON.stringify(this.customers));
                localStorage.setItem('employees', JSON.stringify(this.employees));

                this.saveToLocalStorage(true);
                this.renderAllTables();
                this.renderSalesTable();
                this.renderEmployees();
                this.renderCustomers();
                this.renderCustomerSalesTable();
                this.renderEmployeeSalesTable();
                this.updateStats();
                
                this.showAlert('تمت عملية المرتجع بنجاح', 'success');
                document.getElementById('returnSection').style.display = 'none';
                document.getElementById('returnForm').reset();
            }

            renderSalesTable() {
                const tbody = document.getElementById('salesBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                let totalSales = 0;

                this.sales.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(sale => {
                    totalSales += sale.totalPrice;
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${sale.invoiceNumber}</td>
                        <td>${sale.date}</td>
                        <td>${sale.barcode}</td>
                        <td>${sale.itemName}</td>
                        <td>${sale.customerName}</td>
                        <td>${sale.employeeName || 'غير معروف'}</td>
                        <td>${sale.quantity}</td>
                        <td>${sale.unitPrice.toFixed(2)}</td>
                        <td>${sale.totalPrice.toFixed(2)}</td>
                        <td>${sale.paymentMethod === 'cash' ? 'نقدي' : sale.paymentMethod === 'card' ? 'بطاقة' : 'تحويل'}</td>
                        <td>
                            <span class="badge ${sale.status === 'completed' ? 'badge-success' : 'badge-danger'}">
                                ${sale.status === 'completed' ? 'مكتمل' : 'مرتجع'}
                            </span>
                        </td>
                        <td>
                            <button class="btn-view btn-small" onclick="inventory.showInvoice(${JSON.stringify(sale).replace(/"/g, '&quot;')})">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    `;
                });

                document.getElementById('totalSales').innerHTML = `<strong>${totalSales.toFixed(2)}</strong>`;
            }

            showTodaySales() {
                const today = new Date().toISOString().split('T')[0];
                const todaySales = this.sales.filter(s => s.date === today);
                
                let message = '📊 مبيعات اليوم:\n\n';
                todaySales.forEach(sale => {
                    message += `فاتورة ${sale.invoiceNumber}: ${sale.totalPrice} (${sale.customerName})\n`;
                });
                message += `\nالإجمالي: ${todaySales.reduce((sum, s) => sum + s.totalPrice, 0).toFixed(2)}`;
                
                this.showAlert(message, 'info');
            }

            resetSellForm() {
                document.getElementById('sellForm').reset();
                document.getElementById('sellQuantity').value = '1';
                this.selectedItemForSale = null;
                document.getElementById('stockInfo').innerHTML = '';
            }

            // ================ دوال البحث ================
            searchProducts() {
                const barcode = document.getElementById('searchProductBarcode').value;
                const name = document.getElementById('searchProductName').value;
                const company = document.getElementById('searchProductCompany').value;
                const category = document.getElementById('searchProductCategory').value;

                let results = this.items;

                if (barcode) {
                    results = results.filter(i => i.barcode.includes(barcode));
                }
                if (name) {
                    results = results.filter(i => i.name.includes(name));
                }
                if (company !== 'all') {
                    results = results.filter(i => i.company == company);
                }
                if (category !== 'all') {
                    results = results.filter(i => i.category == category);
                }

                const resultDiv = document.getElementById('productSearchResult');
                resultDiv.innerHTML = '<h4>نتائج البحث:</h4>';
                
                if (results.length === 0) {
                    resultDiv.innerHTML += '<p>لا توجد نتائج</p>';
                    return;
                }

                results.forEach(item => {
                    resultDiv.innerHTML += `
                        <div class="list-item">
                            <div>
                                <strong>${item.name}</strong><br>
                                الباركود: ${item.barcode}<br>
                                الكمية: ${item.quantity} | الوزن: ${item.weight}g | السعر: ${item.totalPrice}
                            </div>
                            <button class="btn-success btn-small" onclick="inventory.quickSell(${item.id})">
                                <i class="fas fa-shopping-cart"></i> بيع
                            </button>
                        </div>
                    `;
                });
            }

            searchInvoices() {
                const invoiceNumber = document.getElementById('searchInvoiceNumber').value;
                const date = document.getElementById('searchInvoiceDate').value;
                const customer = document.getElementById('searchInvoiceCustomer').value;

                let results = this.sales;

                if (invoiceNumber) {
                    results = results.filter(s => s.invoiceNumber.includes(invoiceNumber));
                }
                if (date) {
                    results = results.filter(s => s.date === date);
                }
                if (customer) {
                    results = results.filter(s => s.customerName.includes(customer));
                }

                const resultDiv = document.getElementById('invoiceSearchResult');
                resultDiv.innerHTML = '<h4>نتائج البحث:</h4>';
                
                if (results.length === 0) {
                    resultDiv.innerHTML += '<p>لا توجد نتائج</p>';
                    return;
                }

                results.slice(0, 10).forEach(sale => {
                    resultDiv.innerHTML += `
                        <div class="list-item">
                            <div>
                                <strong>فاتورة ${sale.invoiceNumber}</strong><br>
                                التاريخ: ${sale.date} | العميل: ${sale.customerName}<br>
                                القطعة: ${sale.itemName} | الإجمالي: ${sale.totalPrice}
                            </div>
                            <button class="btn-view btn-small" onclick="inventory.showInvoice(${JSON.stringify(sale).replace(/"/g, '&quot;')})">
                                <i class="fas fa-print"></i> عرض
                            </button>
                        </div>
                    `;
                });
            }

            searchCash() {
                const fromDate = document.getElementById('searchCashFrom').value;
                const toDate = document.getElementById('searchCashTo').value;

                let results = this.cash;

                if (fromDate) {
                    results = results.filter(t => t.date >= fromDate);
                }
                if (toDate) {
                    results = results.filter(t => t.date <= toDate);
                }

                const resultDiv = document.getElementById('cashSearchResult');
                resultDiv.innerHTML = '<h4>نتائج البحث:</h4>';
                
                if (results.length === 0) {
                    resultDiv.innerHTML += '<p>لا توجد نتائج</p>';
                    return;
                }

                let totalIn = 0, totalOut = 0;
                results.forEach(t => {
                    if (t.type === 'in') totalIn += t.amount;
                    else totalOut += t.amount;
                });

                resultDiv.innerHTML += `
                    <p>إجمالي الوارد: ${totalIn.toFixed(2)} | إجمالي المنصرف: ${totalOut.toFixed(2)} | الفرق: ${(totalIn - totalOut).toFixed(2)}</p>
                `;

                results.slice(0, 10).forEach(t => {
                    resultDiv.innerHTML += `
                        <div class="list-item">
                            <div>
                                ${t.date} - ${t.type === 'in' ? 'وارد' : 'منصرف'}: ${t.amount}<br>
                                ${t.description}
                            </div>
                        </div>
                    `;
                });
            }

            // ================ دوال مساعدة ================
            getEmployeeName(employeeId) {
                if (!employeeId) return 'غير معروف';
                const employee = this.employees.find(e => e.id == employeeId);
                return employee ? employee.name : 'غير معروف';
            }

            getCustomerName(customerId) {
                const customer = this.customers.find(c => c.id == customerId);
                return customer ? customer.name : 'غير معروف';
            }

            getCompanyName(companyId) {
                const company = this.companies.find(c => c.id == companyId);
                return company ? company.name : 'غير معروف';
            }

            getCategoryName(categoryId) {
                const category = this.categories.find(c => c.id == categoryId);
                return category ? category.name : 'غير معروف';
            }

            updateStats() {
                document.getElementById('totalCustomers').textContent = this.customers.length;
                document.getElementById('totalItems').textContent = this.items.reduce((sum, item) => sum + (item.quantity || 1), 0);
                document.getElementById('totalEmployees').textContent = this.employees.length;
            }

            saveToLocalStorage(showIndicator = false) {
                try {
                    localStorage.setItem('goldItems', JSON.stringify(this.items));
                    localStorage.setItem('customers', JSON.stringify(this.customers));
                    localStorage.setItem('employees', JSON.stringify(this.employees));
                    localStorage.setItem('companies', JSON.stringify(this.companies));
                    localStorage.setItem('categories', JSON.stringify(this.categories));
                    localStorage.setItem('sales', JSON.stringify(this.sales));
                    localStorage.setItem('cash', JSON.stringify(this.cash));
                    localStorage.setItem('expenses', JSON.stringify(this.expenses));
                    localStorage.setItem('mainGoldPrice21', this.mainGoldPrice21);
                    
                    if (showIndicator) {
                        this.showAutoSaveIndicator();
                    }
                    
                    console.log('تم الحفظ بنجاح في', new Date().toLocaleTimeString());
                } catch (e) {
                    console.error('خطأ في الحفظ:', e);
                    this.showAlert('خطأ في حفظ البيانات', 'error');
                }
            }

            createBackup() {
                const backup = {
                    items: this.items,
                    customers: this.customers,
                    employees: this.employees,
                    companies: this.companies,
                    categories: this.categories,
                    sales: this.sales,
                    cash: this.cash,
                    expenses: this.expenses,
                    mainPrice: this.mainGoldPrice21,
                    date: new Date().toISOString(),
                    developer: 'محمد أحمد فؤاد',
                    phone: '+201010421571'
                };
                
                const backupStr = JSON.stringify(backup, null, 2);
                const blob = new Blob([backupStr], { type: 'application/json' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = `gold_backup_${new Date().toISOString().split('T')[0]}.json`;
                a.click();
                
                URL.revokeObjectURL(url);
                this.showAlert('تم إنشاء نسخة احتياطية بنجاح', 'success');
            }

            restoreFromBackupFile() {
                const input = document.createElement('input');
                input.type = 'file';
                input.accept = '.json';
                
                input.onchange = (e) => {
                    const file = e.target.files[0];
                    const reader = new FileReader();
                    
                    reader.onload = (event) => {
                        try {
                            const backup = JSON.parse(event.target.result);
                            
                            if (backup.items) this.items = backup.items;
                            if (backup.customers) this.customers = backup.customers;
                            if (backup.employees) this.employees = backup.employees;
                            if (backup.companies) this.companies = backup.companies;
                            if (backup.categories) this.categories = backup.categories;
                            if (backup.sales) this.sales = backup.sales;
                            if (backup.cash) this.cash = backup.cash;
                            if (backup.expenses) this.expenses = backup.expenses;
                            if (backup.mainPrice) {
                                this.mainGoldPrice21 = backup.mainPrice;
                                this.updateMainPriceDisplay();
                            }
                            
                            this.saveToLocalStorage(true);
                            this.init();
                            this.showAlert('تم استعادة النسخة الاحتياطية بنجاح', 'success');
                        } catch (error) {
                            console.error(error);
                            this.showAlert('خطأ في قراءة الملف', 'error');
                        }
                    };
                    
                    reader.readAsText(file);
                };
                
                input.click();
            }

            clearAll() {
                if (confirm('⚠️ هل أنت متأكد من مسح جميع البيانات؟\nلا يمكن التراجع عن هذا الإجراء')) {
                    this.items = [];
                    this.customers = [];
                    this.employees = [];
                    this.companies = [];
                    this.categories = [];
                    this.sales = [];
                    this.cash = [];
                    this.expenses = [];
                    this.mainGoldPrice21 = 0;
                    
                    this.saveToLocalStorage(true);
                    this.init();
                    this.showAlert('تم مسح جميع البيانات', 'warning');
                }
            }

            printReport() {
                if (this.items.length === 0 && this.sales.length === 0) {
                    this.showAlert('لا توجد بيانات للطباعة', 'error');
                    return;
                }

                const totalItems = this.items.reduce((sum, item) => sum + (item.quantity || 1), 0);
                const totalWeight = this.items.reduce((sum, item) => sum + (item.weight * (item.quantity || 1)), 0);
                const totalAll = this.items.reduce((sum, item) => sum + (item.totalPrice * (item.quantity || 1)), 0);
                const totalSales = this.sales.reduce((sum, s) => sum + s.totalPrice, 0);
                const todaySales = this.sales.filter(s => s.date === new Date().toISOString().split('T')[0]).reduce((sum, s) => sum + s.totalPrice, 0);
                const cashBalance = this.getCashBalance();

                const printWindow = window.open('', '_blank');
                printWindow.document.write(`
                    <!DOCTYPE html>
                    <html dir="rtl">
                    <head>
                        <title>تقرير النظام المتكامل</title>
                        <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
                        <style>
                            body { font-family: 'Tajawal', sans-serif; padding: 20px; background: #f5f5f5; }
                            .report-container { max-width: 1200px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
                            h1 { color: #d4af37; text-align: center; margin-bottom: 30px; font-size: 32px; }
                            h2 { color: #8b7355; margin: 20px 0 15px; border-bottom: 2px solid #d4af37; padding-bottom: 10px; }
                            .summary-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
                            .summary-card { background: linear-gradient(135deg, #f8f9fa, #e9ecef); padding: 20px; border-radius: 10px; text-align: center; }
                            .summary-card .label { color: #666; font-size: 14px; }
                            .summary-card .value { color: #d4af37; font-size: 24px; font-weight: 700; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th { background: #d4af37; color: white; padding: 12px; }
                            td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
                            .footer { margin-top: 40px; text-align: center; color: #666; border-top: 1px solid #ddd; padding-top: 20px; }
                            .developer { color: #6f42c1; }
                            .whatsapp { color: #25d366; }
                            @media print {
                                body { background: white; }
                                .report-container { box-shadow: none; padding: 0; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="report-container">
                            <h1>📊 تقرير النظام المتكامل لإدارة الذهب</h1>
                            
                            <div class="summary-grid">
                                <div class="summary-card">
                                    <div class="label">إجمالي العملاء</div>
                                    <div class="value">${this.customers.length}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="label">القطع في المخزون</div>
                                    <div class="value">${totalItems}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="label">الموظفين</div>
                                    <div class="value">${this.employees.length}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="label">رصيد الخزنة</div>
                                    <div class="value">${cashBalance.toFixed(2)}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="label">مبيعات اليوم</div>
                                    <div class="value">${todaySales.toFixed(2)}</div>
                                </div>
                                <div class="summary-card">
                                    <div class="label">إجمالي المبيعات</div>
                                    <div class="value">${totalSales.toFixed(2)}</div>
                                </div>
                            </div>

                            <h2>ملخص المخزون</h2>
                            <table>
                                <thead>
                                    <tr>
                                        <th>الباركود</th>
                                        <th>القطعة</th>
                                        <th>الكمية</th>
                                        <th>الوزن</th>
                                        <th>السعر</th>
                                        <th>الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${this.items.slice(0, 20).map(item => `
                                        <tr>
                                            <td>${item.barcode}</td>
                                            <td>${item.name}</td>
                                            <td>${item.quantity || 1}</td>
                                            <td>${(item.weight * (item.quantity || 1)).toFixed(2)}g</td>
                                            <td>${item.totalPrice.toFixed(2)}</td>
                                            <td>${(item.totalPrice * (item.quantity || 1)).toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                                <tfoot>
                                    <tr>
                                        <td colspan="3" class="text-left"><strong>الإجمالي:</strong></td>
                                        <td><strong>${totalWeight.toFixed(2)}g</strong></td>
                                        <td></td>
                                        <td><strong>${totalAll.toFixed(2)}</strong></td>
                                    </tr>
                                </tfoot>
                            </table>

                            <h2>آخر 10 مبيعات</h2>
                            <table>
                                <thead>
                                    <tr>
                                        <th>رقم الفاتورة</th>
                                        <th>التاريخ</th>
                                        <th>القطعة</th>
                                        <th>العميل</th>
                                        <th>الموظف</th>
                                        <th>الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    ${this.sales.slice(0, 10).map(sale => `
                                        <tr>
                                            <td>${sale.invoiceNumber}</td>
                                            <td>${sale.date}</td>
                                            <td>${sale.itemName}</td>
                                            <td>${sale.customerName}</td>
                                            <td>${sale.employeeName || 'غير معروف'}</td>
                                            <td>${sale.totalPrice.toFixed(2)}</td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                            
                            <div class="footer">
                                <p>تم إنشاء هذا التقرير بواسطة <span class="developer">نظام إدارة الذهب المتكامل</span></p>
                                <p>تطوير: <span class="developer">محمد أحمد فؤاد</span> | 
                                   <span class="whatsapp">واتساب: +201010421571</span></p>
                                <p>جميع الحقوق محفوظة © ${new Date().getFullYear()}</p>
                            </div>
                        </div>
                    </body>
                    </html>
                `);
                
                printWindow.document.close();
            }

            exportToExcel(type = 'full') {
                if (this.items.length === 0 && this.sales.length === 0) {
                    this.showAlert('لا توجد بيانات للتصدير', 'error');
                    return;
                }

                const filteredItems = this.getFilteredItems();

                if (type === 'summary') {
                    this.exportSummaryToExcel(filteredItems);
                } else {
                    this.exportFullToExcel(filteredItems);
                }
            }

            exportFullToExcel(items) {
                const totalItems = items.reduce((sum, item) => sum + (item.quantity || 1), 0);
                const totalWeight = items.reduce((sum, item) => sum + (item.weight * (item.quantity || 1)), 0);
                const totalAll = items.reduce((sum, item) => sum + (item.totalPrice * (item.quantity || 1)), 0);
                const totalSales = this.sales.reduce((sum, s) => sum + s.totalPrice, 0);
                const cashBalance = this.getCashBalance();

                const exportData = [
                    ['تقرير النظام المتكامل لإدارة الذهب', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['تاريخ التقرير:', new Date().toLocaleDateString('ar-EG'), '', '', '', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['ملخص عام:', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['العملاء:', this.customers.length, 'الموظفين:', this.employees.length, 'القطع:', totalItems, '', '', '', '', '', '', ''],
                    ['رصيد الخزنة:', cashBalance.toFixed(2), 'إجمالي المبيعات:', totalSales.toFixed(2), '', '', '', '', '', '', '', '', ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['بيانات المخزون:', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['الباركود', 'القطعة', 'الشركة', 'الصنف', 'الكمية', 'الوزن', 'العيار', 'المصنعية', 'سعر الذهب', 'النوع', 'سعر الوحدة', 'الإجمالي', ''],
                    ...items.map(item => [
                        item.barcode,
                        item.name,
                        item.companyName || '',
                        item.categoryName || '',
                        item.quantity || 1,
                        (item.weight * (item.quantity || 1)).toFixed(2) + 'g',
                        item.goldType,
                        (item.manufacturingPrice * (item.quantity || 1)).toFixed(2),
                        item.goldPrice.toFixed(2),
                        item.wholesalePrice ? 'جملة' : 'قطاعي',
                        item.totalPrice.toFixed(2),
                        (item.totalPrice * (item.quantity || 1)).toFixed(2),
                        ''
                    ]),
                    ['', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['الإجمالي:', '', '', '', totalItems, totalWeight.toFixed(2) + 'g', '', '', '', '', '', totalAll.toFixed(2), ''],
                    ['', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['آخر 20 مبيعات:', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['رقم الفاتورة', 'التاريخ', 'القطعة', 'العميل', 'الموظف', 'الكمية', 'سعر الوحدة', 'الإجمالي', 'طريقة الدفع', 'الحالة', '', '', ''],
                    ...this.sales.slice(0, 20).map(sale => [
                        sale.invoiceNumber,
                        sale.date,
                        sale.itemName,
                        sale.customerName,
                        sale.employeeName || '',
                        sale.quantity,
                        sale.unitPrice.toFixed(2),
                        sale.totalPrice.toFixed(2),
                        sale.paymentMethod === 'cash' ? 'نقدي' : sale.paymentMethod === 'card' ? 'بطاقة' : 'تحويل',
                        sale.status === 'completed' ? 'مكتمل' : 'مرتجع',
                        '', '', ''
                    ]),
                    ['', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['معلومات المطور:', '', '', '', '', '', '', '', '', '', '', '', ''],
                    ['تم التطوير بواسطة:', 'محمد أحمد فؤاد', '', '', '', '', '', '', '', '', '', '', ''],
                    ['للتواصل واتساب:', '+201010421571', '', '', '', '', '', '', '', '', '', '', '']
                ];

                const wb = XLSX.utils.book_new();
                const ws = XLSX.utils.aoa_to_sheet(exportData);

                const wscols = [
                    { wch: 15 }, { wch: 20 }, { wch: 15 }, { wch: 15 }, { wch: 8 },
                    { wch: 12 }, { wch: 8 }, { wch: 12 }, { wch: 12 }, { wch: 8 },
                    { wch: 12 }, { wch: 15 }, { wch: 5 }
                ];
                ws['!cols'] = wscols;

                XLSX.utils.book_append_sheet(wb, ws, "تقرير شامل");
                
                const fileName = `تقرير_النظام_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                this.showAlert('تم تصدير الملف بنجاح', 'success');
            }

            exportSummaryToExcel(items) {
                const companiesSummary = {};
                const categoriesSummary = {};

                items.forEach(item => {
                    if (!companiesSummary[item.companyName]) {
                        companiesSummary[item.companyName] = {
                            count: 0, quantity: 0, weight: 0, total: 0
                        };
                    }
                    companiesSummary[item.companyName].count++;
                    companiesSummary[item.companyName].quantity += item.quantity || 1;
                    companiesSummary[item.companyName].weight += item.weight * (item.quantity || 1);
                    companiesSummary[item.companyName].total += item.totalPrice * (item.quantity || 1);

                    if (!categoriesSummary[item.categoryName]) {
                        categoriesSummary[item.categoryName] = {
                            count: 0, quantity: 0, weight: 0, total: 0
                        };
                    }
                    categoriesSummary[item.categoryName].count++;
                    categoriesSummary[item.categoryName].quantity += item.quantity || 1;
                    categoriesSummary[item.categoryName].weight += item.weight * (item.quantity || 1);
                    categoriesSummary[item.categoryName].total += item.totalPrice * (item.quantity || 1);
                });

                const companiesData = [
                    ['ملخص حسب الشركة', '', '', '', ''],
                    ['الشركة', 'عدد القطع', 'إجمالي الكمية', 'الوزن (جرام)', 'الإجمالي'],
                    ...Object.entries(companiesSummary).map(([name, data]) => [
                        name, data.count, data.quantity, data.weight.toFixed(2), data.total.toFixed(2)
                    ])
                ];

                const categoriesData = [
                    ['ملخص حسب الصنف', '', '', '', ''],
                    ['الصنف', 'عدد القطع', 'إجمالي الكمية', 'الوزن (جرام)', 'الإجمالي'],
                    ...Object.entries(categoriesSummary).map(([name, data]) => [
                        name, data.count, data.quantity, data.weight.toFixed(2), data.total.toFixed(2)
                    ])
                ];

                const salesData = [
                    ['ملخص المبيعات', '', ''],
                    ['التاريخ', 'عدد المبيعات', 'الإجمالي'],
                    ...Object.entries(
                        this.sales.reduce((acc, sale) => {
                            if (!acc[sale.date]) acc[sale.date] = { count: 0, total: 0 };
                            acc[sale.date].count++;
                            acc[sale.date].total += sale.totalPrice;
                            return acc;
                        }, {})
                    ).sort().reverse().map(([date, data]) => [date, data.count, data.total.toFixed(2)])
                ];

                const developerData = [
                    ['معلومات المطور', '', ''],
                    ['الاسم', 'محمد أحمد فؤاد', ''],
                    ['رقم الواتساب', '+201010421571', ''],
                    ['', '', ''],
                    ['للتواصل:', 'https://wa.me/201010421571', '']
                ];

                const wb = XLSX.utils.book_new();
                
                const wsCompanies = XLSX.utils.aoa_to_sheet(companiesData);
                wsCompanies['!cols'] = [{ wch: 25 }, { wch: 10 }, { wch: 12 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, wsCompanies, "ملخص الشركات");

                const wsCategories = XLSX.utils.aoa_to_sheet(categoriesData);
                wsCategories['!cols'] = [{ wch: 25 }, { wch: 10 }, { wch: 12 }, { wch: 15 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, wsCategories, "ملخص الأصناف");

                const wsSales = XLSX.utils.aoa_to_sheet(salesData);
                wsSales['!cols'] = [{ wch: 15 }, { wch: 12 }, { wch: 15 }];
                XLSX.utils.book_append_sheet(wb, wsSales, "ملخص المبيعات");

                const wsDeveloper = XLSX.utils.aoa_to_sheet(developerData);
                wsDeveloper['!cols'] = [{ wch: 20 }, { wch: 30 }, { wch: 20 }];
                XLSX.utils.book_append_sheet(wb, wsDeveloper, "المطور");

                const fileName = `ملخص_النظام_${new Date().toISOString().split('T')[0]}.xlsx`;
                XLSX.writeFile(wb, fileName);
                
                this.showAlert('تم تصدير الملف بنجاح', 'success');
            }

            exportToPDF() {
                if (this.items.length === 0) {
                    this.showAlert('لا توجد بيانات للتصدير', 'error');
                    return;
                }

                const filteredItems = this.getFilteredItems();
                const { jsPDF } = window.jspdf;
                const doc = new jsPDF();

                doc.setFontSize(22);
                doc.setTextColor(212, 175, 55);
                doc.text('تقرير النظام المتكامل', 105, 20, { align: 'center' });

                doc.setFontSize(10);
                doc.setTextColor(0, 0, 0);
                doc.text(`تاريخ التقرير: ${new Date().toLocaleDateString('ar-EG')}`, 20, 30);
                doc.text(`العملاء: ${this.customers.length} | الموظفين: ${this.employees.length} | القطع: ${filteredItems.reduce((sum, i) => sum + (i.quantity || 1), 0)}`, 20, 40);

                const tableData = filteredItems.slice(0, 30).map(item => [
                    item.barcode,
                    item.name,
                    item.quantity || 1,
                    `${(item.weight * (item.quantity || 1)).toFixed(2)}g`,
                    item.totalPrice.toFixed(2),
                    (item.totalPrice * (item.quantity || 1)).toFixed(2)
                ]);

                doc.autoTable({
                    head: [['الباركود', 'القطعة', 'الكمية', 'الوزن', 'سعر الوحدة', 'الإجمالي']],
                    body: tableData,
                    startY: 50,
                    theme: 'striped',
                    headStyles: { fillColor: [212, 175, 55] },
                    styles: { halign: 'center', fontSize: 8 }
                });

                doc.save(`تقرير_النظام_${new Date().toISOString().split('T')[0]}.pdf`);
                this.showAlert('تم تصدير الملف بنجاح', 'success');
            }
        }

        // تهيئة التطبيق
        const inventory = new GoldManagementSystem();
        window.inventory = inventory;
    </script>
</body>
</html>