<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام إدارة الذهب المتكامل - الخزنة والمبيعات</title>
    <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #d4af37;
            --secondary-color: #8b7355;
            --success-color: #28a745;
            --danger-color: #dc3545;
            --warning-color: #ffc107;
            --info-color: #17a2b8;
            --dark-color: #343a40;
            --light-color: #f8f9fa;
            --developer-color: #6f42c1;
            --cash-color: #28a745;
            --expense-color: #dc3545;
            --employee-color: #17a2b8;
        }

        body {
            font-family: 'Tajawal', sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
        }

        /* مؤشر الحفظ التلقائي */
        .autosave-indicator {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: var(--success-color);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            display: none;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: slideIn 0.3s ease;
        }

        .autosave-indicator.show {
            display: flex;
        }

        /* حالة الشبكة */
        .network-status {
            position: fixed;
            top: 20px;
            left: 20px;
            padding: 8px 15px;
            border-radius: 50px;
            color: white;
            font-size: 14px;
            display: flex;
            align-items: center;
            gap: 8px;
            z-index: 1000;
        }

        .network-status.online {
            background: var(--success-color);
        }

        .network-status.offline {
            background: var(--danger-color);
        }

        /* توقيع المطور */
        .developer-signature {
            position: fixed;
            bottom: 20px;
            left: 20px;
            background: var(--developer-color);
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            display: flex;
            align-items: center;
            gap: 15px;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(0,0,0,0.2);
            animation: slideInLeft 0.3s ease;
            direction: ltr;
        }

        .developer-signature a {
            color: white;
            text-decoration: none;
            display: flex;
            align-items: center;
            gap: 5px;
            background: rgba(255,255,255,0.2);
            padding: 5px 10px;
            border-radius: 50px;
            transition: all 0.3s;
        }

        .developer-signature a:hover {
            background: rgba(255,255,255,0.3);
            transform: scale(1.05);
        }

        /* الشريط العلوي الرئيسي */
        .main-header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px 15px 0 0;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 0;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .main-header h1 {
            color: var(--primary-color);
            font-size: 28px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .global-stats {
            display: flex;
            gap: 30px;
            flex-wrap: wrap;
        }

        .stat-item {
            background: var(--light-color);
            padding: 10px 20px;
            border-radius: 10px;
            font-size: 18px;
            font-weight: 500;
        }

        .stat-item span:first-child {
            color: var(--secondary-color);
            margin-left: 10px;
        }

        .stat-item span:last-child {
            color: var(--primary-color);
            font-weight: 700;
        }

        /* بطاقات الخزنة */
        .cash-summary {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .cash-card {
            background: linear-gradient(135deg, var(--cash-color), #34ce57);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .cash-card.expense-card {
            background: linear-gradient(135deg, var(--expense-color), #e35d6a);
        }

        .cash-card.employee-card {
            background: linear-gradient(135deg, var(--employee-color), #1c7cd6);
        }

        .cash-card h3 {
            font-size: 16px;
            margin-bottom: 10px;
            opacity: 0.9;
        }

        .cash-card .amount {
            font-size: 32px;
            font-weight: 700;
        }

        .cash-card .small {
            font-size: 14px;
            opacity: 0.8;
            margin-top: 5px;
        }

        /* التاب العلوي */
        .main-tabs {
            background: white;
            padding: 10px 20px 0 20px;
            display: flex;
            gap: 5px;
            border-bottom: 3px solid var(--primary-color);
            flex-wrap: wrap;
            overflow-x: auto;
        }

        .main-tab {
            padding: 15px 25px;
            background: #f5f5f5;
            border: none;
            border-radius: 10px 10px 0 0;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            color: #666;
            display: flex;
            align-items: center;
            gap: 8px;
            transition: all 0.3s;
            font-family: 'Tajawal', sans-serif;
            white-space: nowrap;
        }

        .main-tab i {
            font-size: 18px;
        }

        .main-tab:hover {
            background: #e0e0e0;
        }

        .main-tab.active {
            background: var(--primary-color);
            color: white;
        }

        /* محتوى التاب */
        .main-content {
            background: white;
            padding: 30px;
            border-radius: 0 0 15px 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .tab-pane {
            display: none;
        }

        .tab-pane.active {
            display: block;
        }

        /* أقسام البحث */
        .search-section {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .search-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 15px;
        }

        .search-result {
            margin-top: 15px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            border-right: 4px solid var(--primary-color);
        }

        /* أقسام الإدارة الداخلية */
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 15px;
            flex-wrap: wrap;
            gap: 15px;
        }

        .section-header h2 {
            color: var(--secondary-color);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .header-actions {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }

        .section-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(400px, 1fr));
            gap: 30px;
            margin-bottom: 30px;
        }

        .form-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }

        .form-card h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        .list-card {
            background: #f8f9fa;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            max-height: 500px;
            overflow-y: auto;
        }

        .list-card h3 {
            color: var(--secondary-color);
            margin-bottom: 20px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 10px;
        }

        /* النماذج */
        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            color: var(--secondary-color);
            font-weight: 500;
        }

        .form-group input,
        .form-group select,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s;
        }

        .form-group input:focus,
        .form-group select:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: var(--primary-color);
        }

        .form-row {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
        }

        /* بطاقات العناصر */
        .items-list {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .list-item {
            background: white;
            padding: 15px;
            border-radius: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-right: 4px solid var(--primary-color);
            transition: all 0.3s;
        }

        .list-item:hover {
            transform: translateX(-5px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.1);
        }

        .item-info h4 {
            color: var(--dark-color);
            margin-bottom: 5px;
        }

        .item-info p {
            color: #666;
            font-size: 14px;
        }

        .item-info small {
            color: #999;
        }

        .item-actions {
            display: flex;
            gap: 5px;
        }

        .item-actions button {
            padding: 5px 10px;
            border: none;
            border-radius: 5px;
            cursor: pointer;
            color: white;
            font-size: 12px;
            transition: all 0.3s;
        }

        .item-actions button:hover {
            transform: scale(1.1);
        }

        .btn-edit {
            background: var(--warning-color);
        }

        .btn-delete {
            background: var(--danger-color);
        }

        .btn-view {
            background: var(--info-color);
        }

        .btn-print {
            background: var(--primary-color);
        }

        /* قسم المبيعات */
        .sell-section {
            background: #e8f5e9;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .sell-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            flex-wrap: wrap;
            gap: 10px;
        }

        .sell-header h3 {
            color: var(--success-color);
        }

        .invoice-number {
            background: var(--primary-color);
            color: white;
            padding: 8px 15px;
            border-radius: 50px;
            font-weight: 700;
        }

        .sell-form {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
        }

        .quantity-control {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .quantity-control input {
            width: 80px;
            text-align: center;
        }

        .quantity-control button {
            width: 30px;
            height: 30px;
            border: none;
            border-radius: 5px;
            background: var(--primary-color);
            color: white;
            cursor: pointer;
            font-size: 16px;
        }

        .quantity-control button:hover {
            background: var(--secondary-color);
        }

        .stock-info {
            background: white;
            padding: 10px;
            border-radius: 5px;
            color: var(--info-color);
            font-weight: 500;
        }

        /* قسم المرتجعات */
        .return-section {
            background: #fff3cd;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
        }

        .return-header {
            color: #856404;
            margin-bottom: 15px;
        }

        /* الجداول */
        .table-responsive {
            overflow-x: auto;
        }

        table {
            width: 100%;
            border-collapse: collapse;
            margin: 20px 0;
        }

        th {
            background: var(--primary-color);
            color: white;
            padding: 12px;
            font-weight: 500;
            text-align: center;
        }

        td {
            padding: 10px;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
        }

        tr:hover {
            background: #f5f5f5;
        }

        .badge {
            padding: 5px 10px;
            border-radius: 50px;
            font-size: 12px;
            font-weight: 500;
        }

        .badge-success {
            background: var(--success-color);
            color: white;
        }

        .badge-warning {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        .badge-danger {
            background: var(--danger-color);
            color: white;
        }

        .badge-info {
            background: var(--info-color);
            color: white;
        }

        /* الأزرار */
        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            font-family: 'Tajawal', sans-serif;
            transition: all 0.3s;
        }

        .btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 10px rgba(0,0,0,0.2);
        }

        .btn-primary {
            background: var(--primary-color);
            color: white;
        }

        .btn-success {
            background: var(--success-color);
            color: white;
        }

        .btn-info {
            background: var(--info-color);
            color: white;
        }

        .btn-danger {
            background: var(--danger-color);
            color: white;
        }

        .btn-warning {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        .btn-excel {
            background: #1d6f42;
            color: white;
        }

        .btn-pdf {
            background: #dc3545;
            color: white;
        }

        .btn-print {
            background: #6f42c1;
            color: white;
        }

        .btn-small {
            padding: 8px 16px;
            font-size: 14px;
        }

        /* نافذة الطباعة */
        @media print {
            .no-print {
                display: none !important;
            }
            body {
                background: white;
                padding: 0;
            }
            .invoice-container {
                padding: 20px;
                max-width: 100%;
            }
        }

        .invoice-container {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }

        .invoice-header {
            text-align: center;
            margin-bottom: 30px;
            border-bottom: 2px solid var(--primary-color);
            padding-bottom: 20px;
        }

        .invoice-header h2 {
            color: var(--primary-color);
            font-size: 28px;
            margin-bottom: 10px;
        }

        .invoice-info {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-bottom: 20px;
        }

        /* رسائل التنبيه */
        .alert {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 15px 30px;
            border-radius: 8px;
            color: white;
            font-weight: 500;
            z-index: 1000;
            animation: slideDown 0.3s ease;
        }

        .alert-success {
            background: var(--success-color);
        }

        .alert-error {
            background: var(--danger-color);
        }

        .alert-warning {
            background: var(--warning-color);
            color: var(--dark-color);
        }

        .alert-info {
            background: var(--info-color);
        }

        @keyframes slideDown {
            from {
                top: -100px;
                opacity: 0;
            }
            to {
                top: 20px;
                opacity: 1;
            }
        }

        @keyframes slideIn {
            from {
                right: -100px;
                opacity: 0;
            }
            to {
                right: 20px;
                opacity: 1;
            }
        }

        @keyframes slideInLeft {
            from {
                left: -100px;
                opacity: 0;
            }
            to {
                left: 20px;
                opacity: 1;
            }
        }

        /* التجاوب مع الشاشات */
        @media (max-width: 768px) {
            .main-header {
                flex-direction: column;
                text-align: center;
            }
            
            .global-stats {
                width: 100%;
                justify-content: center;
            }
            
            .main-tabs {
                justify-content: flex-start;
            }
            
            .main-tab {
                padding: 10px 15px;
                font-size: 14px;
            }
            
            .section-grid {
                grid-template-columns: 1fr;
            }
            
            .form-row {
                grid-template-columns: 1fr;
            }
            
            .developer-signature {
                bottom: 10px;
                left: 10px;
                font-size: 12px;
                padding: 8px 15px;
                flex-wrap: wrap;
            }

            .cash-summary {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <!-- مؤشر حالة الشبكة -->
    <div id="networkStatus" class="network-status online">
        <i class="fas fa-wifi"></i>
        <span>متصل بالإنترنت</span>
    </div>

    <!-- مؤشر الحفظ التلقائي -->
    <div id="autosaveIndicator" class="autosave-indicator">
        <i class="fas fa-check-circle"></i>
        <span>تم الحفظ تلقائياً</span>
    </div>

    <!-- توقيع المطور -->
    <div class="developer-signature">
        <i class="fas fa-code"></i>
        <span>تطوير: محمد أحمد فؤاد</span>
        <a href="https://wa.me/201010421571" target="_blank">
            <i class="fab fa-whatsapp"></i>
            +201010421571
        </a>
    </div>

    <div class="container">
        <!-- الشريط العلوي -->
        <header class="main-header">
            <h1><i class="fas fa-gem"></i> نظام إدارة الذهب المتكامل</h1>
            <div class="global-stats">
                <div class="stat-item">
                    <span>العملاء:</span>
                    <span id="totalCustomers">0</span>
                </div>
                <div class="stat-item">
                    <span>القطع:</span>
                    <span id="totalItems">0</span>
                </div>
                <div class="stat-item">
                    <span>الموظفين:</span>
                    <span id="totalEmployees">0</span>
                </div>
                <div class="stat-item">
                    <span>رصيد الخزنة:</span>
                    <span id="cashBalance">0</span>
                </div>
            </div>
        </header>

        <!-- بطاقات الخزنة -->
        <div class="cash-summary">
            <div class="cash-card">
                <h3>رصيد الخزنة الحالي</h3>
                <div class="amount" id="currentCash">0</div>
                <div class="small">آخر تحديث: <span id="lastCashUpdate"></span></div>
            </div>
            <div class="cash-card expense-card">
                <h3>إجمالي المصروفات</h3>
                <div class="amount" id="totalExpenses">0</div>
                <div class="small">هذا الشهر</div>
            </div>
            <div class="cash-card employee-card">
                <h3>إجمالي الرواتب</h3>
                <div class="amount" id="totalSalaries">0</div>
                <div class="small">هذا الشهر</div>
            </div>
        </div>

        <!-- التاب العلوي -->
        <div class="main-tabs">
            <button class="main-tab" onclick="inventory.switchMainTab('search')">
                <i class="fas fa-search"></i>
                بحث
            </button>
            <button class="main-tab active" onclick="inventory.switchMainTab('inventory')">
                <i class="fas fa-boxes"></i>
                المخزون
            </button>
            <button class="main-tab" onclick="inventory.switchMainTab('customers')">
                <i class="fas fa-users"></i>
                العملاء
            </button>
            <button class="main-tab" onclick="inventory.switchMainTab('employees')">
                <i class="fas fa-user-tie"></i>
                الموظفين
            </button>
            <button class="main-tab" onclick="inventory.switchMainTab('sales')">
                <i class="fas fa-chart-line"></i>
                المبيعات
            </button>
            <button class="main-tab" onclick="inventory.switchMainTab('cash')">
                <i class="fas fa-coins"></i>
                الخزنة
            </button>
            <button class="main-tab" onclick="inventory.switchMainTab('expenses')">
                <i class="fas fa-file-invoice"></i>
                المصروفات
            </button>
            <button class="main-tab" onclick="inventory.switchMainTab('companies')">
                <i class="fas fa-building"></i>
                الشركات
            </button>
            <button class="main-tab" onclick="inventory.switchMainTab('categories')">
                <i class="fas fa-tags"></i>
                الأصناف
            </button>
        </div>

        <!-- محتوى التاب - بحث -->
        <div id="search-tab" class="main-content tab-pane">
            <div class="section-header">
                <h2><i class="fas fa-search"></i> بحث متقدم</h2>
            </div>

            <div class="search-section">
                <h3>بحث عن منتج</h3>
                <div class="search-grid">
                    <div class="form-group">
                        <label>بحث بالباركود</label>
                        <input type="text" id="searchProductBarcode" placeholder="أدخل الباركود">
                    </div>
                    <div class="form-group">
                        <label>بحث بالاسم</label>
                        <input type="text" id="searchProductName" placeholder="أدخل اسم المنتج">
                    </div>
                    <div class="form-group">
                        <label>بحث بالشركة</label>
                        <select id="searchProductCompany">
                            <option value="all">جميع الشركات</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label>بحث بالصنف</label>
                        <select id="searchProductCategory">
                            <option value="all">جميع الأصناف</option>
                        </select>
                    </div>
                </div>
                <button class="btn btn-primary" onclick="inventory.searchProducts()">
                    <i class="fas fa-search"></i> بحث
                </button>
                <div id="productSearchResult" class="search-result"></div>
            </div>

            <div class="search-section">
                <h3>بحث عن فاتورة</h3>
                <div class="search-grid">
                    <div class="form-group">
                        <label>رقم الفاتورة</label>
                        <input type="text" id="searchInvoiceNumber" placeholder="أدخل رقم الفاتورة">
                    </div>
                    <div class="form-group">
                        <label>تاريخ الفاتورة</label>
                        <input type="date" id="searchInvoiceDate">
                    </div>
                    <div class="form-group">
                        <label>اسم العميل</label>
                        <input type="text" id="searchInvoiceCustomer" placeholder="أدخل اسم العميل">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="inventory.searchInvoices()">
                    <i class="fas fa-search"></i> بحث
                </button>
                <div id="invoiceSearchResult" class="search-result"></div>
            </div>

            <div class="search-section">
                <h3>بحث في الخزنة</h3>
                <div class="search-grid">
                    <div class="form-group">
                        <label>من تاريخ</label>
                        <input type="date" id="searchCashFrom">
                    </div>
                    <div class="form-group">
                        <label>إلى تاريخ</label>
                        <input type="date" id="searchCashTo">
                    </div>
                </div>
                <button class="btn btn-primary" onclick="inventory.searchCash()">
                    <i class="fas fa-search"></i> بحث
                </button>
                <div id="cashSearchResult" class="search-result"></div>
            </div>
        </div>

        <!-- محتوى التاب - المخزون (موجود سابقاً) -->
        <div id="inventory-tab" class="main-content tab-pane active">
            <!-- محتوى المخزون السابق -->
        </div>

        <!-- محتوى التاب - العملاء (موجود سابقاً) -->
        <div id="customers-tab" class="main-content tab-pane">
            <!-- محتوى العملاء السابق -->
        </div>

        <!-- محتوى التاب - الموظفين -->
        <div id="employees-tab" class="main-content tab-pane">
            <div class="section-header">
                <h2><i class="fas fa-user-tie"></i> إدارة الموظفين</h2>
            </div>
            
            <div class="section-grid">
                <!-- إضافة موظف جديد -->
                <div class="form-card">
                    <h3>إضافة موظف جديد</h3>
                    <form id="employeeForm">
                        <div class="form-group">
                            <label for="employeeName">اسم الموظف</label>
                            <input type="text" id="employeeName" required placeholder="أدخل اسم الموظف">
                        </div>
                        <div class="form-group">
                            <label for="employeePhone">رقم الهاتف</label>
                            <input type="text" id="employeePhone" placeholder="أدخل رقم الهاتف">
                        </div>
                        <div class="form-group">
                            <label for="employeePosition">الوظيفة</label>
                            <input type="text" id="employeePosition" placeholder="أدخل الوظيفة">
                        </div>
                        <div class="form-group">
                            <label for="employeeSalary">الراتب الشهري</label>
                            <input type="number" id="employeeSalary" step="0.01" min="0" value="0" placeholder="أدخل الراتب">
                        </div>
                        <div class="form-group">
                            <label for="employeeHireDate">تاريخ التعيين</label>
                            <input type="date" id="employeeHireDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label for="employeeNotes">ملاحظات</label>
                            <textarea id="employeeNotes" placeholder="ملاحظات إضافية"></textarea>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> حفظ الموظف
                        </button>
                    </form>
                </div>

                <!-- قائمة الموظفين -->
                <div class="list-card">
                    <h3>قائمة الموظفين</h3>
                    <div id="employeesList" class="items-list"></div>
                </div>
            </div>

            <!-- سجل مبيعات الموظفين -->
            <div class="list-card" style="margin-top: 20px;">
                <h3>سجل مبيعات الموظفين</h3>
                <div class="table-responsive">
                    <table id="employeeSalesTable">
                        <thead>
                            <tr>
                                <th>الموظف</th>
                                <th>عدد المبيعات</th>
                                <th>إجمالي المبيعات</th>
                                <th>الراتب الشهري</th>
                                <th>الحالة</th>
                            </tr>
                        </thead>
                        <tbody id="employeeSalesBody"></tbody>
                    </table>
                </div>
            </div>
        </div>

        <!-- محتوى التاب - المبيعات -->
        <div id="sales-tab" class="main-content tab-pane">
            <div class="section-header">
                <h2><i class="fas fa-shopping-cart"></i> إدارة المبيعات</h2>
                <div class="header-actions">
                    <button class="btn btn-info" onclick="inventory.showTodaySales()">
                        <i class="fas fa-calendar-day"></i> مبيعات اليوم
                    </button>
                    <button class="btn btn-warning" onclick="inventory.showReturns()">
                        <i class="fas fa-undo"></i> عرض المرتجعات
                    </button>
                </div>
            </div>

            <!-- قسم البيع السريع -->
            <div class="sell-section">
                <div class="sell-header">
                    <h3>فاتورة بيع جديدة</h3>
                    <div class="invoice-number">
                        فاتورة رقم: <span id="invoiceNumber">${Math.floor(Math.random() * 10000).toString().padStart(5, '0')}</span>
                    </div>
                </div>
                <form id="sellForm" class="sell-form">
                    <div class="form-group">
                        <label for="sellBarcode">الباركود</label>
                        <input type="text" id="sellBarcode" placeholder="أدخل الباركود">
                    </div>
                    <div class="form-group">
                        <label for="sellCustomer">اختر العميل</label>
                        <select id="sellCustomer" required>
                            <option value="">اختر العميل</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sellEmployee">اختر الموظف</label>
                        <select id="sellEmployee" required>
                            <option value="">اختر الموظف</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sellQuantity">الكمية</label>
                        <div class="quantity-control">
                            <button type="button" onclick="inventory.adjustQuantity(-1)">-</button>
                            <input type="number" id="sellQuantity" min="1" value="1">
                            <button type="button" onclick="inventory.adjustQuantity(1)">+</button>
                        </div>
                    </div>
                    <div class="form-group">
                        <label for="sellPrice">سعر البيع</label>
                        <input type="number" id="sellPrice" step="0.01" readonly>
                    </div>
                    <div class="form-group">
                        <label for="sellTotal">الإجمالي</label>
                        <input type="number" id="sellTotal" step="0.01" readonly>
                    </div>
                    <div class="form-group">
                        <label for="sellPayment">طريقة الدفع</label>
                        <select id="sellPayment">
                            <option value="cash">نقدي</option>
                            <option value="card">بطاقة</option>
                            <option value="transfer">تحويل بنكي</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="sellNotes">ملاحظات</label>
                        <textarea id="sellNotes" placeholder="ملاحظات"></textarea>
                    </div>
                    <div class="stock-info" id="stockInfo"></div>
                    <button type="submit" class="btn btn-success">
                        <i class="fas fa-check"></i> تأكيد البيع
                    </button>
                    <button type="button" class="btn btn-primary" onclick="inventory.printInvoice()">
                        <i class="fas fa-print"></i> طباعة الفاتورة
                    </button>
                </form>
            </div>

            <!-- قسم المرتجعات -->
            <div class="return-section" id="returnSection" style="display: none;">
                <div class="return-header">
                    <h3><i class="fas fa-undo"></i> مرتجع فاتورة</h3>
                </div>
                <form id="returnForm" class="sell-form">
                    <div class="form-group">
                        <label for="returnInvoice">رقم الفاتورة</label>
                        <input type="text" id="returnInvoice" placeholder="أدخل رقم الفاتورة">
                    </div>
                    <div class="form-group">
                        <label for="returnReason">سبب المرتجع</label>
                        <select id="returnReason">
                            <option value="defect">عيب في المنتج</option>
                            <option value="customer">رغبة العميل</option>
                            <option value="wrong">خطأ في الفاتورة</option>
                            <option value="other">أخرى</option>
                        </select>
                    </div>
                    <div class="form-group">
                        <label for="returnQuantity">الكمية المرتجعة</label>
                        <input type="number" id="returnQuantity" min="1" value="1">
                    </div>
                    <button type="submit" class="btn btn-warning">
                        <i class="fas fa-undo"></i> تأكيد المرتجع
                    </button>
                </form>
            </div>

            <!-- سجل المبيعات -->
            <div class="list-card">
                <h3>سجل المبيعات</h3>
                <div class="table-responsive">
                    <table id="salesTable">
                        <thead>
                            <tr>
                                <th>رقم الفاتورة</th>
                                <th>التاريخ</th>
                                <th>الباركود</th>
                                <th>القطعة</th>
                                <th>العميل</th>
                                <th>الموظف</th>
                                <th>الكمية</th>
                                <th>السعر</th>
                                <th>الإجمالي</th>
                                <th>طريقة الدفع</th>
                                <th>الحالة</th>
                                <th>الإجراءات</th>
                            </tr>
                        </thead>
                        <tbody id="salesBody"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="8" class="text-left">إجمالي المبيعات:</td>
                                <td id="totalSales">0</td>
                                <td colspan="3"></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- محتوى التاب - الخزنة -->
        <div id="cash-tab" class="main-content tab-pane">
            <div class="section-header">
                <h2><i class="fas fa-coins"></i> إدارة الخزنة</h2>
                <button class="btn btn-success" onclick="inventory.addToCash()">
                    <i class="fas fa-plus"></i> إيداع
                </button>
                <button class="btn btn-danger" onclick="inventory.withdrawFromCash()">
                    <i class="fas fa-minus"></i> سحب
                </button>
            </div>

            <!-- حركة الخزنة -->
            <div class="list-card">
                <h3>حركة الخزنة</h3>
                <div class="table-responsive">
                    <table id="cashTable">
                        <thead>
                            <tr>
                                <th>التاريخ</th>
                                <th>النوع</th>
                                <th>البيان</th>
                                <th>الوارد</th>
                                <th>المنصرف</th>
                                <th>الرصيد</th>
                                <th>بواسطة</th>
                            </tr>
                        </thead>
                        <tbody id="cashBody"></tbody>
                        <tfoot>
                            <tr>
                                <td colspan="3" class="text-left">الإجمالي:</td>
                                <td id="totalCashIn">0</td>
                                <td id="totalCashOut">0</td>
                                <td id="finalCashBalance">0</td>
                                <td></td>
                            </tr>
                        </tfoot>
                    </table>
                </div>
            </div>
        </div>

        <!-- محتوى التاب - المصروفات -->
        <div id="expenses-tab" class="main-content tab-pane">
            <div class="section-header">
                <h2><i class="fas fa-file-invoice"></i> إدارة المصروفات</h2>
                <button class="btn btn-primary" onclick="inventory.addExpense()">
                    <i class="fas fa-plus"></i> إضافة مصروف
                </button>
            </div>

            <div class="section-grid">
                <!-- إضافة مصروف -->
                <div class="form-card">
                    <h3>إضافة مصروف جديد</h3>
                    <form id="expenseForm">
                        <div class="form-group">
                            <label for="expenseDate">التاريخ</label>
                            <input type="date" id="expenseDate" value="${new Date().toISOString().split('T')[0]}">
                        </div>
                        <div class="form-group">
                            <label for="expenseType">نوع المصروف</label>
                            <select id="expenseType" required>
                                <option value="rent">إيجار</option>
                                <option value="electricity">كهرباء</option>
                                <option value="water">مياه</option>
                                <option value="salaries">رواتب</option>
                                <option value="maintenance">صيانة</option>
                                <option value="other">أخرى</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label for="expenseAmount">المبلغ</label>
                            <input type="number" id="expenseAmount" step="0.01" min="0" required placeholder="أدخل المبلغ">
                        </div>
                        <div class="form-group">
                            <label for="expenseDescription">البيان</label>
                            <textarea id="expenseDescription" placeholder="وصف المصروف"></textarea>
                        </div>
                        <div class="form-group">
                            <label for="expenseEmployee">بواسطة</label>
                            <select id="expenseEmployee">
                                <option value="">اختر الموظف</option>
                            </select>
                        </div>
                        <button type="submit" class="btn btn-success">
                            <i class="fas fa-save"></i> حفظ المصروف
                        </button>
                    </form>
                </div>

                <!-- قائمة المصروفات -->
                <div class="list-card">
                    <h3>سجل المصروفات</h3>
                    <div class="table-responsive">
                        <table id="expensesTable">
                            <thead>
                                <tr>
                                    <th>التاريخ</th>
                                    <th>النوع</th>
                                    <th>البيان</th>
                                    <th>المبلغ</th>
                                    <th>بواسطة</th>
                                    <th>الإجراءات</th>
                                </tr>
                            </thead>
                            <tbody id="expensesBody"></tbody>
                            <tfoot>
                                <tr>
                                    <td colspan="3" class="text-left">إجمالي المصروفات:</td>
                                    <td id="totalExpensesAmount">0</td>
                                    <td colspan="2"></td>
                                </tr>
                            </tfoot>
                        </table>
                    </div>
                </div>
            </div>
        </div>

        <!-- باقي التابات (الشركات والأصناف) موجودة سابقاً -->
        <div id="companies-tab" class="main-content tab-pane">
            <!-- محتوى الشركات السابق -->
        </div>

        <div id="categories-tab" class="main-content tab-pane">
            <!-- محتوى الأصناف السابق -->
        </div>

        <!-- أزرار التصدير -->
        <div style="margin-top: 20px;">
            <div class="export-buttons">
                <button id="exportExcel" class="btn btn-excel">
                    <i class="fas fa-file-excel"></i> تصدير Excel شامل
                </button>
                <button id="exportPDF" class="btn btn-pdf">
                    <i class="fas fa-file-pdf"></i> تصدير PDF
                </button>
                <button id="printReport" class="btn btn-print">
                    <i class="fas fa-print"></i> طباعة التقرير
                </button>
                <button id="backupData" class="btn btn-backup">
                    <i class="fas fa-database"></i> نسخ احتياطي
                </button>
            </div>
        </div>
    </div>

    <!-- نافذة طباعة الفاتورة المخفية -->
    <div id="invoicePrint" style="display: none;"></div>

    <!-- مكان عرض رسائل التنبيه -->
    <div id="alert-container"></div>

    <!-- المكتبات الخارجية -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/quagga/0.12.1/quagga.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
    
    <script>
        // نظام إدارة الذهب المتكامل مع الخزنة والمصروفات
        class GoldManagementSystem {
            constructor() {
                this.restoreFromBackup();
                this.customers = JSON.parse(localStorage.getItem('customers')) || [];
                this.employees = JSON.parse(localStorage.getItem('employees')) || [];
                this.companies = JSON.parse(localStorage.getItem('companies')) || [];
                this.categories = JSON.parse(localStorage.getItem('categories')) || [];
                this.sales = JSON.parse(localStorage.getItem('sales')) || [];
                this.cash = JSON.parse(localStorage.getItem('cash')) || [];
                this.expenses = JSON.parse(localStorage.getItem('expenses')) || [];
                this.mainGoldPrice21 = parseFloat(localStorage.getItem('mainGoldPrice21')) || 0;
                this.isScanning = false;
                this.currentFilters = {
                    company: 'all',
                    category: 'all',
                    goldType: 'all',
                    priceType: 'all'
                };
                this.selectedItemForSale = null;
                this.currentInvoiceNumber = this.generateInvoiceNumber();
                this.init();
                this.setupNetworkMonitoring();
                this.setupAutoSave();
                this.setupBeforeUnload();
            }

            restoreFromBackup() {
                try {
                    const mainData = localStorage.getItem('goldItems');
                    if (mainData) {
                        this.items = JSON.parse(mainData);
                    } else {
                        const backupData = localStorage.getItem('goldItems_backup');
                        if (backupData) {
                            this.items = JSON.parse(backupData);
                        } else {
                            this.items = [];
                        }
                    }

                    if (!Array.isArray(this.items)) {
                        this.items = [];
                    }

                    this.items = this.items.map(item => ({
                        ...item,
                        id: item.id || Date.now() + Math.random(),
                        quantity: item.quantity || 1
                    }));

                } catch (e) {
                    console.error('خطأ في استعادة البيانات:', e);
                    this.items = [];
                }
            }

            init() {
                this.updateMainPriceDisplay();
                this.renderEmployees();
                this.renderCustomers();
                this.renderCompanies();
                this.renderCategories();
                this.renderCompanySelects();
                this.renderCategorySelects();
                this.renderCustomerSelects();
                this.renderEmployeeSelects();
                this.renderAllTables();
                this.renderSalesTable();
                this.renderCashTable();
                this.renderExpensesTable();
                this.updateStats();
                this.updateCashBalance();
                this.setupEventListeners();
            }

            generateInvoiceNumber() {
                const lastNumber = parseInt(localStorage.getItem('lastInvoiceNumber')) || 10000;
                const newNumber = lastNumber + 1;
                localStorage.setItem('lastInvoiceNumber', newNumber);
                return newNumber.toString().padStart(6, '0');
            }

            generateBarcode() {
                const prefix = 'GLD';
                const timestamp = Date.now().toString().slice(-8);
                const random = Math.floor(Math.random() * 1000).toString().padStart(3, '0');
                return `${prefix}${timestamp}${random}`;
            }

            setupNetworkMonitoring() {
                window.addEventListener('online', () => {
                    document.getElementById('networkStatus').className = 'network-status online';
                    document.getElementById('networkStatus').innerHTML = '<i class="fas fa-wifi"></i><span>متصل بالإنترنت</span>';
                    this.showAlert('تم استعادة الاتصال بالإنترنت', 'success');
                });

                window.addEventListener('offline', () => {
                    document.getElementById('networkStatus').className = 'network-status offline';
                    document.getElementById('networkStatus').innerHTML = '<i class="fas fa-wifi-slash"></i><span>غير متصل بالإنترنت</span>';
                    this.showAlert('أنت الآن غير متصل بالإنترنت - يتم الحفظ محلياً', 'warning');
                });
            }

            setupAutoSave() {
                setInterval(() => {
                    this.saveToLocalStorage(true);
                }, 30000);
            }

            setupBeforeUnload() {
                window.addEventListener('beforeunload', () => {
                    this.saveToLocalStorage(true);
                });
            }

            showAutoSaveIndicator() {
                const indicator = document.getElementById('autosaveIndicator');
                indicator.classList.add('show');
                setTimeout(() => {
                    indicator.classList.remove('show');
                }, 2000);
            }

            setupEventListeners() {
                // باقي الإعدادات
                document.getElementById('employeeForm').addEventListener('submit', (e) => this.addEmployee(e));
                document.getElementById('expenseForm').addEventListener('submit', (e) => this.addExpense(e));
                document.getElementById('sellForm').addEventListener('submit', (e) => this.processSale(e));
                document.getElementById('returnForm').addEventListener('submit', (e) => this.processReturn(e));
                document.getElementById('sellBarcode').addEventListener('input', (e) => this.searchItemForSale(e.target.value));
                document.getElementById('sellQuantity').addEventListener('input', () => this.updateSaleTotal());
            }

            switchMainTab(tabId) {
                document.querySelectorAll('.tab-pane').forEach(tab => tab.classList.remove('active'));
                document.querySelectorAll('.main-tab').forEach(btn => btn.classList.remove('active'));
                document.getElementById(`${tabId}-tab`).classList.add('active');
                event.target.classList.add('active');
            }

            // ================ إدارة الموظفين ================
            addEmployee(event) {
                event.preventDefault();

                const employee = {
                    id: Date.now() + Math.random(),
                    name: document.getElementById('employeeName').value,
                    phone: document.getElementById('employeePhone').value,
                    position: document.getElementById('employeePosition').value,
                    salary: parseFloat(document.getElementById('employeeSalary').value) || 0,
                    hireDate: document.getElementById('employeeHireDate').value,
                    notes: document.getElementById('employeeNotes').value,
                    totalSales: 0,
                    salesCount: 0,
                    date: new Date().toISOString()
                };

                this.employees.push(employee);
                localStorage.setItem('employees', JSON.stringify(this.employees));
                
                this.renderEmployees();
                this.renderEmployeeSelects();
                this.resetEmployeeForm();
                this.showAlert('تم إضافة الموظف بنجاح', 'success');
            }

            deleteEmployee(id) {
                if (confirm('هل أنت متأكد من حذف هذا الموظف؟')) {
                    this.employees = this.employees.filter(e => e.id !== id);
                    localStorage.setItem('employees', JSON.stringify(this.employees));
                    this.renderEmployees();
                    this.renderEmployeeSelects();
                    this.showAlert('تم حذف الموظف بنجاح', 'warning');
                }
            }

            renderEmployees() {
                const list = document.getElementById('employeesList');
                if (!list) return;
                
                list.innerHTML = '';

                this.employees.forEach(employee => {
                    const div = document.createElement('div');
                    div.className = 'list-item';
                    div.innerHTML = `
                        <div class="item-info">
                            <h4>${employee.name}</h4>
                            <p>📞 ${employee.phone || 'لا يوجد هاتف'}</p>
                            <p>${employee.position || ''} - الراتب: ${employee.salary}</p>
                            <small>مبيعات: ${employee.salesCount} | إجمالي: ${employee.totalSales.toFixed(2)}</small>
                        </div>
                        <div class="item-actions">
                            <button class="btn-delete" onclick="inventory.deleteEmployee(${employee.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </div>
                    `;
                    list.appendChild(div);
                });
            }

            renderEmployeeSelects() {
                const selects = ['sellEmployee', 'expenseEmployee'];
                
                selects.forEach(selectId => {
                    const select = document.getElementById(selectId);
                    if (select) {
                        select.innerHTML = '<option value="">اختر الموظف</option>';
                        
                        this.employees.forEach(employee => {
                            const option = document.createElement('option');
                            option.value = employee.id;
                            option.textContent = employee.name;
                            select.appendChild(option);
                        });
                    }
                });
            }

            resetEmployeeForm() {
                document.getElementById('employeeName').value = '';
                document.getElementById('employeePhone').value = '';
                document.getElementById('employeePosition').value = '';
                document.getElementById('employeeSalary').value = '';
                document.getElementById('employeeNotes').value = '';
            }

            // ================ إدارة الخزنة ================
            getCashBalance() {
                let balance = 0;
                this.cash.forEach(transaction => {
                    if (transaction.type === 'in') balance += transaction.amount;
                    else if (transaction.type === 'out') balance -= transaction.amount;
                });
                return balance;
            }

            addCashTransaction(type, amount, description, employeeId = null, relatedId = null) {
                const transaction = {
                    id: Date.now() + Math.random(),
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toLocaleTimeString(),
                    type: type,
                    amount: amount,
                    description: description,
                    employeeId: employeeId,
                    employeeName: employeeId ? this.getEmployeeName(employeeId) : 'النظام',
                    relatedId: relatedId,
                    balance: this.getCashBalance() + (type === 'in' ? amount : -amount)
                };

                this.cash.push(transaction);
                localStorage.setItem('cash', JSON.stringify(this.cash));
                this.renderCashTable();
                this.updateCashBalance();
                return transaction;
            }

            addToCash() {
                const amount = parseFloat(prompt('أدخل المبلغ المراد إيداعه:'));
                if (amount && amount > 0) {
                    const description = prompt('أدخل البيان:');
                    this.addCashTransaction('in', amount, description || 'إيداع');
                    this.showAlert('تم إضافة المبلغ إلى الخزنة', 'success');
                }
            }

            withdrawFromCash() {
                const amount = parseFloat(prompt('أدخل المبلغ المراد سحبه:'));
                if (amount && amount > 0) {
                    if (amount > this.getCashBalance()) {
                        this.showAlert('الرصيد غير كافي', 'error');
                        return;
                    }
                    const description = prompt('أدخل البيان:');
                    this.addCashTransaction('out', amount, description || 'سحب');
                    this.showAlert('تم سحب المبلغ من الخزنة', 'success');
                }
            }

            renderCashTable() {
                const tbody = document.getElementById('cashBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                let totalIn = 0;
                let totalOut = 0;
                let balance = 0;

                this.cash.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(transaction => {
                    if (transaction.type === 'in') {
                        totalIn += transaction.amount;
                        balance += transaction.amount;
                    } else {
                        totalOut += transaction.amount;
                        balance -= transaction.amount;
                    }

                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${transaction.date}</td>
                        <td>${transaction.type === 'in' ? 'وارد' : 'منصرف'}</td>
                        <td>${transaction.description}</td>
                        <td>${transaction.type === 'in' ? transaction.amount.toFixed(2) : '-'}</td>
                        <td>${transaction.type === 'out' ? transaction.amount.toFixed(2) : '-'}</td>
                        <td>${balance.toFixed(2)}</td>
                        <td>${transaction.employeeName}</td>
                    `;
                });

                document.getElementById('totalCashIn').textContent = totalIn.toFixed(2);
                document.getElementById('totalCashOut').textContent = totalOut.toFixed(2);
                document.getElementById('finalCashBalance').textContent = balance.toFixed(2);
            }

            updateCashBalance() {
                const balance = this.getCashBalance();
                document.getElementById('currentCash').textContent = balance.toFixed(2);
                document.getElementById('cashBalance').textContent = balance.toFixed(2);
                document.getElementById('lastCashUpdate').textContent = new Date().toLocaleTimeString();
            }

            // ================ إدارة المصروفات ================
            addExpense(event) {
                event.preventDefault();

                const expense = {
                    id: Date.now() + Math.random(),
                    date: document.getElementById('expenseDate').value,
                    type: document.getElementById('expenseType').value,
                    amount: parseFloat(document.getElementById('expenseAmount').value),
                    description: document.getElementById('expenseDescription').value,
                    employeeId: document.getElementById('expenseEmployee').value,
                    employeeName: this.getEmployeeName(document.getElementById('expenseEmployee').value),
                    timestamp: new Date().toISOString()
                };

                this.expenses.push(expense);
                localStorage.setItem('expenses', JSON.stringify(this.expenses));

                // إضافة إلى الخزنة
                this.addCashTransaction('out', expense.amount, `مصروف: ${expense.description}`, expense.employeeId, expense.id);

                this.renderExpensesTable();
                this.resetExpenseForm();
                this.showAlert('تم إضافة المصروف بنجاح', 'success');
            }

            deleteExpense(id) {
                if (confirm('هل أنت متأكد من حذف هذا المصروف؟')) {
                    this.expenses = this.expenses.filter(e => e.id !== id);
                    localStorage.setItem('expenses', JSON.stringify(this.expenses));
                    this.renderExpensesTable();
                    this.showAlert('تم حذف المصروف بنجاح', 'warning');
                }
            }

            renderExpensesTable() {
                const tbody = document.getElementById('expensesBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                let totalExpenses = 0;

                this.expenses.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(expense => {
                    totalExpenses += expense.amount;
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${expense.date}</td>
                        <td>${expense.type}</td>
                        <td>${expense.description}</td>
                        <td>${expense.amount.toFixed(2)}</td>
                        <td>${expense.employeeName || 'غير معروف'}</td>
                        <td>
                            <button class="btn-delete" onclick="inventory.deleteExpense(${expense.id})">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    `;
                });

                document.getElementById('totalExpenses').textContent = totalExpenses.toFixed(2);
                document.getElementById('totalExpensesAmount').textContent = totalExpenses.toFixed(2);
            }

            resetExpenseForm() {
                document.getElementById('expenseType').value = 'rent';
                document.getElementById('expenseAmount').value = '';
                document.getElementById('expenseDescription').value = '';
            }

            // ================ إدارة المبيعات ================
            searchItemForSale(barcode) {
                const stockInfo = document.getElementById('stockInfo');
                if (!barcode) {
                    this.selectedItemForSale = null;
                    stockInfo.innerHTML = '';
                    document.getElementById('sellPrice').value = '';
                    document.getElementById('sellTotal').value = '';
                    return;
                }

                const item = this.items.find(i => i.barcode === barcode);
                if (item) {
                    this.selectedItemForSale = item;
                    stockInfo.innerHTML = `القطعة: ${item.name} | المتوفر: ${item.quantity} | السعر: ${item.totalPrice}`;
                    document.getElementById('sellPrice').value = item.totalPrice;
                    this.updateSaleTotal();
                } else {
                    this.selectedItemForSale = null;
                    stockInfo.innerHTML = 'القطعة غير موجودة في المخزون';
                    document.getElementById('sellPrice').value = '';
                    document.getElementById('sellTotal').value = '';
                }
            }

            adjustQuantity(change) {
                const input = document.getElementById('sellQuantity');
                let value = parseInt(input.value) || 1;
                value += change;
                if (value < 1) value = 1;
                if (this.selectedItemForSale && value > this.selectedItemForSale.quantity) {
                    value = this.selectedItemForSale.quantity;
                    this.showAlert('الكمية المتاحة: ' + this.selectedItemForSale.quantity, 'warning');
                }
                input.value = value;
                this.updateSaleTotal();
            }

            updateSaleTotal() {
                const price = parseFloat(document.getElementById('sellPrice').value) || 0;
                const quantity = parseInt(document.getElementById('sellQuantity').value) || 1;
                document.getElementById('sellTotal').value = (price * quantity).toFixed(2);
            }

            processSale(event) {
                event.preventDefault();

                if (!this.selectedItemForSale) {
                    this.showAlert('الرجاء اختيار قطعة صالحة', 'error');
                    return;
                }

                const customerId = document.getElementById('sellCustomer').value;
                if (!customerId) {
                    this.showAlert('الرجاء اختيار العميل', 'error');
                    return;
                }

                const employeeId = document.getElementById('sellEmployee').value;
                if (!employeeId) {
                    this.showAlert('الرجاء اختيار الموظف', 'error');
                    return;
                }

                const quantity = parseInt(document.getElementById('sellQuantity').value) || 1;
                if (quantity > this.selectedItemForSale.quantity) {
                    this.showAlert('الكمية المطلوبة أكبر من المتوفر', 'error');
                    return;
                }

                const invoiceNumber = this.generateInvoiceNumber();
                const totalPrice = this.selectedItemForSale.totalPrice * quantity;

                const sale = {
                    id: Date.now() + Math.random(),
                    invoiceNumber: invoiceNumber,
                    date: new Date().toISOString().split('T')[0],
                    time: new Date().toLocaleTimeString(),
                    barcode: this.selectedItemForSale.barcode,
                    itemName: this.selectedItemForSale.name,
                    itemId: this.selectedItemForSale.id,
                    customerId: customerId,
                    customerName: this.getCustomerName(customerId),
                    employeeId: employeeId,
                    employeeName: this.getEmployeeName(employeeId),
                    quantity: quantity,
                    weight: this.selectedItemForSale.weight,
                    unitPrice: this.selectedItemForSale.totalPrice,
                    totalPrice: totalPrice,
                    paymentMethod: document.getElementById('sellPayment').value,
                    notes: document.getElementById('sellNotes').value,
                    status: 'completed',
                    timestamp: new Date().toISOString()
                };

                // تحديث المخزون
                const itemIndex = this.items.findIndex(i => i.id === this.selectedItemForSale.id);
                if (itemIndex !== -1) {
                    this.items[itemIndex].quantity -= quantity;
                    if (this.items[itemIndex].quantity <= 0) {
                        this.items.splice(itemIndex, 1);
                    }
                }

                // تحديث إحصائيات الموظف
                const employeeIndex = this.employees.findIndex(e => e.id == employeeId);
                if (employeeIndex !== -1) {
                    this.employees[employeeIndex].totalSales += totalPrice;
                    this.employees[employeeIndex].salesCount++;
                }

                // إضافة إلى الخزنة
                this.addCashTransaction('in', totalPrice, `فاتورة رقم: ${invoiceNumber}`, employeeId, sale.id);

                // حفظ المبيعة
                this.sales.push(sale);
                localStorage.setItem('sales', JSON.stringify(this.sales));
                localStorage.setItem('employees', JSON.stringify(this.employees));

                this.saveToLocalStorage(true);
                this.renderAllTables();
                this.renderSalesTable();
                this.renderEmployees();
                this.updateStats();
                this.resetSellForm();
                
                this.showAlert(`تمت عملية البيع بنجاح - فاتورة رقم: ${invoiceNumber}`, 'success');
                
                // عرض الفاتورة
                this.showInvoice(sale);
            }

            showInvoice(sale) {
                const invoiceHtml = this.generateInvoiceHtml(sale);
                const printWindow = window.open('', '_blank');
                printWindow.document.write(invoiceHtml);
                printWindow.document.close();
            }

            generateInvoiceHtml(sale) {
                return `
                    <!DOCTYPE html>
                    <html dir="rtl">
                    <head>
                        <meta charset="UTF-8">
                        <title>فاتورة رقم ${sale.invoiceNumber}</title>
                        <link href="https://fonts.googleapis.com/css2?family=Tajawal:wght@300;400;500;700&display=swap" rel="stylesheet">
                        <style>
                            body { font-family: 'Tajawal', sans-serif; padding: 20px; background: #f5f5f5; }
                            .invoice-container { max-width: 800px; margin: 0 auto; background: white; padding: 30px; border-radius: 15px; box-shadow: 0 4px 15px rgba(0,0,0,0.1); }
                            .invoice-header { text-align: center; margin-bottom: 30px; border-bottom: 2px solid #d4af37; padding-bottom: 20px; }
                            .invoice-header h1 { color: #d4af37; font-size: 32px; margin-bottom: 10px; }
                            .invoice-header h2 { color: #8b7355; font-size: 24px; }
                            .invoice-info { display: grid; grid-template-columns: repeat(2, 1fr); gap: 20px; margin-bottom: 30px; }
                            .info-item { background: #f8f9fa; padding: 10px; border-radius: 8px; }
                            .info-item strong { color: #8b7355; }
                            table { width: 100%; border-collapse: collapse; margin: 20px 0; }
                            th { background: #d4af37; color: white; padding: 12px; }
                            td { padding: 10px; border-bottom: 1px solid #ddd; text-align: center; }
                            .total-row { background: #e8f5e9; font-weight: 700; font-size: 18px; }
                            .footer { margin-top: 40px; text-align: center; color: #666; border-top: 1px solid #ddd; padding-top: 20px; }
                            .developer { color: #6f42c1; }
                            .whatsapp { color: #25d366; }
                            @media print {
                                body { background: white; }
                                .invoice-container { box-shadow: none; padding: 0; }
                                .no-print { display: none; }
                            }
                        </style>
                    </head>
                    <body>
                        <div class="invoice-container">
                            <div class="invoice-header">
                                <h1>نظام إدارة الذهب المتكامل</h1>
                                <h2>فاتورة بيع</h2>
                            </div>
                            
                            <div class="invoice-info">
                                <div class="info-item">
                                    <strong>رقم الفاتورة:</strong> ${sale.invoiceNumber}
                                </div>
                                <div class="info-item">
                                    <strong>تاريخ الفاتورة:</strong> ${sale.date}
                                </div>
                                <div class="info-item">
                                    <strong>العميل:</strong> ${sale.customerName}
                                </div>
                                <div class="info-item">
                                    <strong>الموظف:</strong> ${sale.employeeName}
                                </div>
                                <div class="info-item">
                                    <strong>طريقة الدفع:</strong> ${sale.paymentMethod === 'cash' ? 'نقدي' : sale.paymentMethod === 'card' ? 'بطاقة' : 'تحويل بنكي'}
                                </div>
                                <div class="info-item">
                                    <strong>وقت الفاتورة:</strong> ${sale.time}
                                </div>
                            </div>

                            <table>
                                <thead>
                                    <tr>
                                        <th>الباركود</th>
                                        <th>القطعة</th>
                                        <th>الكمية</th>
                                        <th>الوزن</th>
                                        <th>سعر الوحدة</th>
                                        <th>الإجمالي</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>${sale.barcode}</td>
                                        <td>${sale.itemName}</td>
                                        <td>${sale.quantity}</td>
                                        <td>${sale.weight}g</td>
                                        <td>${sale.unitPrice.toFixed(2)}</td>
                                        <td>${sale.totalPrice.toFixed(2)}</td>
                                    </tr>
                                </tbody>
                                <tfoot>
                                    <tr class="total-row">
                                        <td colspan="5" class="text-left">الإجمالي الكلي:</td>
                                        <td>${sale.totalPrice.toFixed(2)}</td>
                                    </tr>
                                </tfoot>
                            </table>

                            <div class="footer">
                                <p>شكراً لتعاملكم معنا</p>
                                <p>تم التطوير بواسطة <span class="developer">محمد أحمد فؤاد</span> | 
                                   <span class="whatsapp">واتساب: +201010421571</span></p>
                            </div>
                            
                            <div class="no-print" style="text-align: center; margin-top: 20px;">
                                <button onclick="window.print()" style="padding: 10px 20px; background: #d4af37; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">طباعة</button>
                                <button onclick="window.close()" style="padding: 10px 20px; background: #dc3545; color: white; border: none; border-radius: 5px; cursor: pointer; margin: 5px;">إغلاق</button>
                            </div>
                        </div>
                    </body>
                    </html>
                `;
            }

            printInvoice() {
                if (!this.selectedItemForSale) {
                    this.showAlert('الرجاء اختيار قطعة أولاً', 'error');
                    return;
                }
                
                // حفظ البيع أولاً ثم طباعة الفاتورة
                document.getElementById('sellForm').dispatchEvent(new Event('submit'));
            }

            showReturns() {
                const returnSection = document.getElementById('returnSection');
                returnSection.style.display = returnSection.style.display === 'none' ? 'block' : 'none';
            }

            processReturn(event) {
                event.preventDefault();

                const invoiceNumber = document.getElementById('returnInvoice').value;
                const reason = document.getElementById('returnReason').value;
                const quantity = parseInt(document.getElementById('returnQuantity').value) || 1;

                // البحث عن الفاتورة
                const sale = this.sales.find(s => s.invoiceNumber === invoiceNumber);
                if (!sale) {
                    this.showAlert('رقم الفاتورة غير موجود', 'error');
                    return;
                }

                if (sale.status === 'returned') {
                    this.showAlert('هذه الفاتورة مرتجعة مسبقاً', 'error');
                    return;
                }

                if (quantity > sale.quantity) {
                    this.showAlert('الكمية المرتجعة أكبر من الكمية المباعة', 'error');
                    return;
                }

                // إعادة القطعة للمخزون
                const existingItem = this.items.find(i => i.barcode === sale.barcode);
                if (existingItem) {
                    existingItem.quantity += quantity;
                } else {
                    // استعادة القطعة إذا كانت محذوفة
                    this.items.push({
                        id: sale.itemId || Date.now() + Math.random(),
                        barcode: sale.barcode,
                        name: sale.itemName,
                        quantity: quantity,
                        weight: sale.weight,
                        // باقي البيانات من المبيعة
                    });
                }

                // تحديث المبيعة
                sale.status = quantity === sale.quantity ? 'returned' : 'partially_returned';
                sale.returnReason = reason;
                sale.returnDate = new Date().toISOString().split('T')[0];

                // سحب المبلغ من الخزنة
                const returnAmount = sale.unitPrice * quantity;
                this.addCashTransaction('out', returnAmount, `مرتجع فاتورة رقم: ${invoiceNumber}`, null, sale.id);

                // تحديث إحصائيات الموظف
                if (sale.employeeId) {
                    const employee = this.employees.find(e => e.id == sale.employeeId);
                    if (employee) {
                        employee.totalSales -= returnAmount;
                        if (quantity === sale.quantity) {
                            employee.salesCount--;
                        }
                    }
                }

                this.saveToLocalStorage(true);
                this.renderAllTables();
                this.renderSalesTable();
                this.renderEmployees();
                this.updateStats();
                
                this.showAlert('تمت عملية المرتجع بنجاح', 'success');
                document.getElementById('returnSection').style.display = 'none';
                document.getElementById('returnForm').reset();
            }

            renderSalesTable() {
                const tbody = document.getElementById('salesBody');
                if (!tbody) return;
                
                tbody.innerHTML = '';
                
                let totalSales = 0;

                this.sales.sort((a, b) => new Date(b.date) - new Date(a.date)).forEach(sale => {
                    totalSales += sale.totalPrice;
                    const row = tbody.insertRow();
                    row.innerHTML = `
                        <td>${sale.invoiceNumber}</td>
                        <td>${sale.date}</td>
                        <td>${sale.barcode}</td>
                        <td>${sale.itemName}</td>
                        <td>${sale.customerName}</td>
                        <td>${sale.employeeName || 'غير معروف'}</td>
                        <td>${sale.quantity}</td>
                        <td>${sale.unitPrice.toFixed(2)}</td>
                        <td>${sale.totalPrice.toFixed(2)}</td>
                        <td>${sale.paymentMethod === 'cash' ? 'نقدي' : sale.paymentMethod === 'card' ? 'بطاقة' : 'تحويل'}</td>
                        <td>
                            <span class="badge ${sale.status === 'completed' ? 'badge-success' : 'badge-danger'}">
                                ${sale.status === 'completed' ? 'مكتمل' : 'مرتجع'}
                            </span>
                        </td>
                        <td>
                            <button class="btn-view btn-small" onclick="inventory.showInvoice(${JSON.stringify(sale).replace(/"/g, '&quot;')})">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    `;
                });

                document.getElementById('totalSales').textContent = totalSales.toFixed(2);
            }

            showTodaySales() {
                const today = new Date().toISOString().split('T')[0];
                const todaySales = this.sales.filter(s => s.date === today);
                
                let message = 'مبيعات اليوم:\n';
                todaySales.forEach(sale => {
                    message += `فاتورة ${sale.invoiceNumber}: ${sale.totalPrice}\n`;
                });
                message += `الإجمالي: ${todaySales.reduce((sum, s) => sum + s.totalPrice, 0).toFixed(2)}`;
                
                this.showAlert(message, 'info');
            }

            // ================ البحث المتقدم ================
            searchProducts() {
                const barcode = document.getElementById('searchProductBarcode').value;
                const name = document.getElementById('searchProductName').value;
                const company = document.getElementById('searchProductCompany').value;
                const category = document.getElementById('searchProductCategory').value;

                let results = this.items;

                if (barcode) {
                    results = results.filter(i => i.barcode.includes(barcode));
                }
                if (name) {
                    results = results.filter(i => i.name.includes(name));
                }
                if (company !== 'all') {
                    results = results.filter(i => i.company == company);
                }
                if (category !== 'all') {
                    results = results.filter(i => i.category == category);
                }

                const resultDiv = document.getElementById('productSearchResult');
                resultDiv.innerHTML = '<h4>نتائج البحث:</h4>';
                
                if (results.length === 0) {
                    resultDiv.innerHTML += '<p>لا توجد نتائج</p>';
                    return;
                }

                results.forEach(item => {
                    resultDiv.innerHTML += `
                        <div class="list-item">
                            <div>
                                <strong>${item.name}</strong><br>
                                الباركود: ${item.barcode}<br>
                                الكمية: ${item.quantity} | الوزن: ${item.weight}g | السعر: ${item.totalPrice}
                            </div>
                            <button class="btn-small btn-success" onclick="inventory.quickSell(${item.id})">
                                <i class="fas fa-shopping-cart"></i> بيع
                            </button>
                        </div>
                    `;
                });
            }

            searchInvoices() {
                const invoiceNumber = document.getElementById('searchInvoiceNumber').value;
                const date = document.getElementById('searchInvoiceDate').value;
                const customer = document.getElementById('searchInvoiceCustomer').value;

                let results = this.sales;

                if (invoiceNumber) {
                    results = results.filter(s => s.invoiceNumber.includes(invoiceNumber));
                }
                if (date) {
                    results = results.filter(s => s.date === date);
                }
                if (customer) {
                    results = results.filter(s => s.customerName.includes(customer));
                }

                const resultDiv = document.getElementById('invoiceSearchResult');
                resultDiv.innerHTML = '<h4>نتائج البحث:</h4>';
                
                if (results.length === 0) {
                    resultDiv.innerHTML += '<p>لا توجد نتائج</p>';
                    return;
                }

                results.forEach(sale => {
                    resultDiv.innerHTML += `
                        <div class="list-item">
                            <div>
                                <strong>فاتورة ${sale.invoiceNumber}</strong><br>
                                التاريخ: ${sale.date} | العميل: ${sale.customerName}<br>
                                القطعة: ${sale.itemName} | الإجمالي: ${sale.totalPrice}
                            </div>
                            <button class="btn-small btn-primary" onclick="inventory.showInvoice(${JSON.stringify(sale).replace(/"/g, '&quot;')})">
                                <i class="fas fa-print"></i> عرض
                            </button>
                        </div>
                    `;
                });
            }

            searchCash() {
                const fromDate = document.getElementById('searchCashFrom').value;
                const toDate = document.getElementById('searchCashTo').value;

                let results = this.cash;

                if (fromDate) {
                    results = results.filter(t => t.date >= fromDate);
                }
                if (toDate) {
                    results = results.filter(t => t.date <= toDate);
                }

                const resultDiv = document.getElementById('cashSearchResult');
                resultDiv.innerHTML = '<h4>نتائج البحث:</h4>';
                
                if (results.length === 0) {
                    resultDiv.innerHTML += '<p>لا توجد نتائج</p>';
                    return;
                }

                let totalIn = 0, totalOut = 0;
                results.forEach(t => {
                    if (t.type === 'in') totalIn += t.amount;
                    else totalOut += t.amount;
                });

                resultDiv.innerHTML += `
                    <p>إجمالي الوارد: ${totalIn.toFixed(2)} | إجمالي المنصرف: ${totalOut.toFixed(2)} | الفرق: ${(totalIn - totalOut).toFixed(2)}</p>
                `;

                results.slice(0, 10).forEach(t => {
                    resultDiv.innerHTML += `
                        <div class="list-item">
                            <div>
                                ${t.date} - ${t.type === 'in' ? 'وارد' : 'منصرف'}: ${t.amount}<br>
                                ${t.description}
                            </div>
                        </div>
                    `;
                });
            }

            // ================ دوال مساعدة ================
            getEmployeeName(employeeId) {
                if (!employeeId) return 'غير معروف';
                const employee = this.employees.find(e => e.id == employeeId);
                return employee ? employee.name : 'غير معروف';
            }

            getCustomerName(customerId) {
                const customer = this.customers.find(c => c.id == customerId);
                return customer ? customer.name : 'غير معروف';
            }

            getCompanyName(companyId) {
                const company = this.companies.find(c => c.id == companyId);
                return company ? company.name : 'غير معروف';
            }

            getCategoryName(categoryId) {
                const category = this.categories.find(c => c.id == categoryId);
                return category ? category.name : 'غير معروف';
            }

            showAlert(message, type = 'success') {
                const alertContainer = document.getElementById('alert-container');
                const alert = document.createElement('div');
                alert.className = `alert alert-${type}`;
                alert.textContent = message;
                alertContainer.innerHTML = '';
                alertContainer.appendChild(alert);
                
                setTimeout(() => {
                    alert.remove();
                }, 3000);
            }

            resetSellForm() {
                document.getElementById('sellForm').reset();
                document.getElementById('sellQuantity').value = '1';
                this.selectedItemForSale = null;
                document.getElementById('stockInfo').innerHTML = '';
            }

            saveToLocalStorage(showIndicator = false) {
                try {
                    localStorage.setItem('goldItems', JSON.stringify(this.items));
                    localStorage.setItem('goldItems_backup', JSON.stringify(this.items));
                    localStorage.setItem('customers', JSON.stringify(this.customers));
                    localStorage.setItem('employees', JSON.stringify(this.employees));
                    localStorage.setItem('companies', JSON.stringify(this.companies));
                    localStorage.setItem('categories', JSON.stringify(this.categories));
                    localStorage.setItem('sales', JSON.stringify(this.sales));
                    localStorage.setItem('cash', JSON.stringify(this.cash));
                    localStorage.setItem('expenses', JSON.stringify(this.expenses));
                    
                    const backupKey = `gold_backup_${new Date().toISOString().split('T')[0]}`;
                    const fullBackup = {
                        items: this.items,
                        customers: this.customers,
                        employees: this.employees,
                        companies: this.companies,
                        categories: this.categories,
                        sales: this.sales,
                        cash: this.cash,
                        expenses: this.expenses,
                        mainPrice: this.mainGoldPrice21,
                        date: new Date().toISOString()
                    };
                    localStorage.setItem(backupKey, JSON.stringify(fullBackup));
                    
                    if (showIndicator) {
                        this.showAutoSaveIndicator();
                    }
                    
                    console.log('تم الحفظ بنجاح في', new Date().toLocaleTimeString());
                } catch (e) {
                    console.error('خطأ في الحفظ:', e);
                    this.showAlert('خطأ في حفظ البيانات', 'error');
                }
            }

            // باقي الدوال من الكود السابق (التي لم تتغير)...
            // (سيتم إضافتها من الكود السابق للحفاظ على الوظائف الموجودة)
        }

        // تهيئة التطبيق
        const inventory = new GoldManagementSystem();

        // جعل الكائن متاحاً عالمياً للأزرار
        window.inventory = inventory;
    </script>
</body>
</html>